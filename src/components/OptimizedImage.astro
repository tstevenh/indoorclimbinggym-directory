---
/**
 * OptimizedImage Component
 * Handles image optimization for both external (Unsplash) and local images
 * Provides lazy loading, responsive images, and prevents layout shift
 * Automatically falls back to placeholder if image URL is missing/invalid
 */
import { optimizeUnsplashUrl, generateSrcset, getImageUrl, PLACEHOLDER_IMAGE } from '../utils/imageUtils';

interface Props {
  src: string | null | undefined;
  alt: string;
  width: number;
  height: number;
  class?: string;
  loading?: 'lazy' | 'eager';
  sizes?: string; // Responsive sizes attribute
  quality?: number;
  srcsetSizes?: number[]; // Array of widths for srcset generation
}

const {
  src,
  alt,
  width,
  height,
  class: className = '',
  loading = 'lazy',
  sizes,
  quality = 75,
  srcsetSizes,
} = Astro.props;

// Get valid image URL (falls back to placeholder if null/undefined/empty)
const validSrc = getImageUrl(src);
const isPlaceholder = validSrc === PLACEHOLDER_IMAGE;

// Determine if this is an external URL (Unsplash)
const isExternal = validSrc.startsWith('http://') || validSrc.startsWith('https://');
const isUnsplash = validSrc.includes('unsplash.com');

// Optimize the primary image URL if it's Unsplash
const optimizedSrc = isUnsplash
  ? optimizeUnsplashUrl(validSrc, width, height, quality)
  : validSrc;

// Generate srcset if sizes are provided and it's Unsplash (not for placeholder)
const srcset =
  isUnsplash && srcsetSizes && srcsetSizes.length > 0 && !isPlaceholder
    ? generateSrcset(validSrc, srcsetSizes, height / width, quality)
    : undefined;

// Calculate aspect ratio for CSS to prevent CLS
const aspectRatio = (height / width) * 100;
---

<div class={`relative overflow-hidden ${className}`} style={`aspect-ratio: ${width} / ${height};`}>
  <img
    src={optimizedSrc}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    decoding="async"
    srcset={srcset}
    sizes={sizes}
    class="w-full h-full object-cover"
  />
</div>

<style>
  /* Fallback for browsers that don't support aspect-ratio */
  @supports not (aspect-ratio: 1 / 1) {
    div {
      position: relative;
    }
    div::before {
      content: '';
      display: block;
      padding-top: calc(var(--aspect-ratio) * 1%);
    }
    img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  }
</style>
