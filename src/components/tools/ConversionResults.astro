---
/**
 * Conversion Results Display
 * Shows grade equivalents in mobile-friendly card layout
 */

import ConfidenceIndicator from './ConfidenceIndicator.astro';

interface Props {
  gradeData: any | null;
  isGym?: boolean;
}

const { gradeData, isGym = true } = Astro.props;

if (!gradeData) {
  // No grade selected yet
  return null;
}

// Extract data
const { display, equivalents, skill_level, description, gym_outdoor_diff } = gradeData;

// Calculate adjusted grade for gym vs outdoor
let adjustedGrade = display;
let gymNote = null;

if (isGym && gym_outdoor_diff !== 0) {
  // Gym grades are softer - show what outdoor grade it's equivalent to
  const adjustment = Math.abs(gym_outdoor_diff);
  gymNote = `Indoor gym ${display} ‚âà Outdoor ${display.replace(/\d+/, (match) => parseInt(match) - adjustment)}`;
}

// Skill level badge colors
const skillLevelColors = {
  'Beginner': 'bg-blue-100 text-blue-800',
  'Intermediate': 'bg-purple-100 text-purple-800',
  'Advanced': 'bg-orange-100 text-orange-800',
  'Elite': 'bg-red-100 text-red-800'
};

const skillColor = skillLevelColors[skill_level] || 'bg-gray-100 text-gray-800';
---

<div class="conversion-results mt-8 mb-8">
  <!-- Selected grade header -->
  <div class="results-header bg-sage text-white rounded-lg p-6 mb-6 text-center">
    <div class="flex items-center justify-center gap-3 mb-2">
      <h3 class="text-4xl md:text-5xl font-bold">{display}</h3>
      <span class={`skill-badge px-3 py-1 rounded-full text-sm font-semibold ${skillColor}`}>
        {skill_level}
      </span>
    </div>
    <p class="text-lg text-white/90">{description}</p>

    {gymNote && (
      <div class="gym-note mt-3 p-3 bg-white/10 rounded-md text-sm">
        <p class="font-medium">üè¢ {gymNote}</p>
      </div>
    )}
  </div>

  <!-- Conversion cards -->
  <div class="conversions-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {Object.entries(equivalents).map(([system, data]: [string, any]) => {
      // Format system name
      const systemName = system
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');

      return (
        <div class="conversion-card bg-white border-2 border-gray-200 rounded-lg p-5 hover:shadow-lg transition-shadow">
          <!-- System name -->
          <div class="system-name text-sm font-semibold text-gray-500 mb-2">
            {systemName}
          </div>

          <!-- Grade value -->
          <div class="grade-value text-3xl font-bold text-granite mb-3">
            {data.value}
          </div>

          <!-- Confidence indicator -->
          <div class="mb-3">
            <ConfidenceIndicator level={data.confidence} size="sm" />
          </div>

          <!-- Regional note -->
          {data.note && (
            <div class="regional-note p-3 bg-ivory rounded-md">
              <p class="text-sm text-gray-700">
                <span class="font-semibold">Note:</span> {data.note}
              </p>
            </div>
          )}
        </div>
      );
    })}
  </div>

  <!-- Copy button (optional enhancement) -->
  <div class="mt-6 text-center">
    <button
      type="button"
      class="copy-button px-6 py-3 bg-sage text-white font-semibold rounded-lg hover:bg-sage/90 transition-colors focus:outline-none focus:ring-2 focus:ring-sage focus:ring-offset-2"
      data-grade={display}
      data-equivalents={JSON.stringify(equivalents)}
    >
      üìã Copy Conversions
    </button>
    <p class="copy-feedback hidden mt-2 text-sm text-green-600 font-medium">
      ‚úì Copied to clipboard!
    </p>
  </div>
</div>

<style>
  .conversion-card {
    transition: all 200ms ease;
  }

  .conversion-card:hover {
    border-color: #98a48b; /* sage */
  }

  .skill-badge {
    display: inline-block;
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    .results-header h3 {
      font-size: 2.5rem;
    }

    .conversions-grid {
      gap: 1rem;
    }
  }
</style>

<script>
  // Copy functionality
  document.addEventListener('click', (e) => {
    const button = e.target;
    if (button.classList.contains('copy-button')) {
      const grade = button.getAttribute('data-grade');
      const equivalents = JSON.parse(button.getAttribute('data-equivalents'));

      // Format text for clipboard
      let text = `Climbing Grade: ${grade}\n\nConversions:\n`;

      for (const [system, data] of Object.entries(equivalents)) {
        const systemName = system
          .split('_')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');

        text += `‚Ä¢ ${systemName}: ${data.value} (${data.confidence} confidence)\n`;
      }

      text += `\nConverted with IndoorClimbingGym.com`;

      // Copy to clipboard
      navigator.clipboard.writeText(text).then(() => {
        // Show feedback
        const feedback = document.querySelector('.copy-feedback');
        feedback.classList.remove('hidden');

        setTimeout(() => {
          feedback.classList.add('hidden');
        }, 3000);
      });
    }
  });
</script>
