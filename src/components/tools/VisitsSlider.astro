---
/**
 * VisitsSlider Component
 * Interactive range slider with synced number input for selecting visits per month
 * Features: Real-time updates, custom sage green styling, accessibility
 */

interface Props {
  id?: string;
  defaultValue?: number;
}

const { id = 'visits-per-month', defaultValue = 8 } = Astro.props;
---

<div id="step3" class="visits-slider-container">
  <label for={id} class="block text-sm font-semibold text-granite mb-3">
    How often do you climb?
  </label>

  <!-- Slider + Number Input Row -->
  <div class="flex items-center gap-4 mb-2">
    <!-- Range Slider -->
    <input
      type="range"
      id={id}
      class="flex-1 h-2 bg-gray-200 rounded-full appearance-none cursor-pointer
             focus:outline-none focus:ring-2 focus:ring-sage focus:ring-offset-2 transition-all"
      min="1"
      max="30"
      value={defaultValue}
      step="1"
      role="slider"
      aria-label="Number of visits per month"
      aria-valuemin="1"
      aria-valuemax="30"
      aria-valuenow={defaultValue}
      aria-valuetext={`${defaultValue} visits per month`}
    />

    <!-- Number Input (Synced) -->
    <input
      type="number"
      id={`${id}-number`}
      class="w-20 px-3 py-2 border-2 border-gray-300 rounded-lg text-center font-bold text-granite
             focus:border-sage focus:ring-2 focus:ring-sage/20 outline-none transition-colors"
      min="1"
      max="30"
      value={defaultValue}
      aria-label="Visits per month (number input)"
    />
  </div>

  <!-- Label (Real-time update) -->
  <p id={`${id}-label`} class="text-base text-gray-600 mt-2">
    <span id={`${id}-label-text`} class="font-semibold text-sage">{defaultValue}</span> visits per month
  </p>

  <!-- Visual Guide -->
  <div class="mt-4 grid grid-cols-3 gap-2 text-xs text-gray-500">
    <div class="text-left">
      <span class="font-semibold">1</span> - Casual
    </div>
    <div class="text-center">
      <span class="font-semibold">8</span> - Regular
    </div>
    <div class="text-right">
      <span class="font-semibold">30</span> - Daily
    </div>
  </div>
</div>

<style>
  /* Custom slider styling for sage green fill */
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #98a48b; /* sage */
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    margin-top: -8px; /* Centers thumb on 8px track: (8 - 24) / 2 */
  }

  input[type="range"]::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #98a48b; /* sage */
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  input[type="range"]::-webkit-slider-runnable-track {
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(to right,
      #98a48b 0%,
      #98a48b var(--slider-progress, 27%),
      #e5e7eb var(--slider-progress, 27%),
      #e5e7eb 100%
    );
  }

  input[type="range"]::-moz-range-track {
    height: 8px;
    border-radius: 4px;
    background: #e5e7eb;
  }

  input[type="range"]::-moz-range-progress {
    height: 8px;
    border-radius: 4px 0 0 4px;
    background: #98a48b;
  }

  input[type="range"]:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 3px rgba(152, 164, 139, 0.3);
  }

  input[type="range"]:focus::-moz-range-thumb {
    box-shadow: 0 0 0 3px rgba(152, 164, 139, 0.3);
  }
</style>

<script define:vars={{ id, defaultValue }}>
  (function() {
    const slider = document.getElementById(id);
    const numberInput = document.getElementById(`${id}-number`);
    const labelText = document.getElementById(`${id}-label-text`);

    if (!slider || !numberInput || !labelText) return;

    let currentValue = defaultValue;

    // Update visual fill for slider
    function updateSliderFill(value) {
      const percentage = ((value - 1) / 29) * 100; // 1-30 range
      slider.style.setProperty('--slider-progress', `${percentage}%`);
    }

    // Update all UI elements
    function updateUI(value) {
      currentValue = value;
      numberInput.value = value;
      labelText.textContent = value;
      slider.setAttribute('aria-valuenow', value);
      slider.setAttribute('aria-valuetext', `${value} visits per month`);
      updateSliderFill(value);
    }

    // Slider input handler
    slider.addEventListener('input', (e) => {
      const value = parseInt(e.target.value);
      updateUI(value);

      // Dispatch custom event for parent components
      const event = new CustomEvent('visitsChanged', {
        detail: { visits: value },
        bubbles: true
      });
      slider.dispatchEvent(event);
    });

    // Number input handler
    numberInput.addEventListener('input', (e) => {
      let value = parseInt(e.target.value);

      // Clamp value between 1 and 30
      if (isNaN(value)) value = 1;
      if (value < 1) value = 1;
      if (value > 30) value = 30;

      slider.value = value;
      updateUI(value);

      // Dispatch custom event
      const event = new CustomEvent('visitsChanged', {
        detail: { visits: value },
        bubbles: true
      });
      numberInput.dispatchEvent(event);
    });

    // Initialize slider visual on load
    updateSliderFill(currentValue);
  })();
</script>
