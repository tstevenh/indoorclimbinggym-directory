---
/**
 * Grade Search Bar with Autocomplete
 * Mobile-first search input that provides instant suggestions
 */

interface Props {
  gradeData: Record<string, any>;
  placeholder?: string;
  id?: string;
}

const { gradeData, placeholder = "Enter grade (e.g., V5, 5.12a)", id = "grade-search" } = Astro.props;

// Generate all possible search terms from grade data
const allGrades = Object.keys(gradeData).map(key => gradeData[key].display);
---

<div class="grade-search-container relative">
  <label for={id} class="block text-sm font-semibold text-granite mb-2">
    Search for a grade:
  </label>

  <div class="relative">
    <input
      type="text"
      id={id}
      class="grade-search-input w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-lg focus:border-sage focus:ring-2 focus:ring-sage/20 outline-none transition-colors"
      placeholder={placeholder}
      autocomplete="off"
      role="combobox"
      aria-expanded="false"
      aria-autocomplete="list"
      aria-controls={`${id}-suggestions`}
    />

    <!-- Search icon -->
    <svg
      class="absolute right-4 top-1/2 transform -translate-y-1/2 w-6 h-6 text-gray-400 pointer-events-none"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
  </div>

  <!-- Autocomplete suggestions dropdown -->
  <ul
    id={`${id}-suggestions`}
    class="suggestions-list absolute z-50 w-full mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-64 overflow-y-auto hidden"
    role="listbox"
  >
    <!-- Populated dynamically by JavaScript -->
  </ul>
</div>

<style>
  .suggestions-list li {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 150ms;
  }

  .suggestions-list li:hover,
  .suggestions-list li[aria-selected="true"] {
    background-color: #f8f8f5; /* ivory */
  }

  .suggestions-list li.highlighted {
    background-color: #98a48b; /* sage */
    color: white;
  }

  /* Scrollbar styling for suggestions */
  .suggestions-list::-webkit-scrollbar {
    width: 8px;
  }

  .suggestions-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 0 0.5rem 0.5rem 0;
  }

  .suggestions-list::-webkit-scrollbar-thumb {
    background: #98a48b;
    border-radius: 4px;
  }

  .suggestions-list::-webkit-scrollbar-thumb:hover {
    background: #7a8670;
  }
</style>

<script define:vars={{ allGrades, id }}>
  // Client-side autocomplete logic
  (function() {
    const input = document.getElementById(id);
    const suggestionsList = document.getElementById(`${id}-suggestions`);
    let currentFocus = -1;
    let availableGrades = allGrades;

    function filterGrades(query) {
      if (!query) return [];

      const normalizedQuery = query.toLowerCase().replace(/\s+/g, '');

      return availableGrades.filter(grade => {
        const normalizedGrade = grade.toLowerCase().replace(/\s+/g, '');
        return normalizedGrade.includes(normalizedQuery);
      }).slice(0, 10); // Limit to 10 suggestions
    }

    function showSuggestions(suggestions) {
      if (suggestions.length === 0) {
        hideSuggestions();
        return;
      }

      suggestionsList.innerHTML = suggestions
        .map((grade, index) =>
          `<li role="option" data-grade="${grade}" data-index="${index}">${grade}</li>`
        )
        .join('');

      suggestionsList.classList.remove('hidden');
      input.setAttribute('aria-expanded', 'true');
      currentFocus = -1;
    }

    function hideSuggestions() {
      suggestionsList.classList.add('hidden');
      input.setAttribute('aria-expanded', 'false');
      currentFocus = -1;
    }

    function selectGrade(grade) {
      input.value = grade;
      hideSuggestions();

      // Dispatch custom event with selected grade
      const event = new CustomEvent('gradeSelected', {
        detail: { grade },
        bubbles: true
      });
      input.dispatchEvent(event);
    }

    function highlightSuggestion(index) {
      const items = suggestionsList.querySelectorAll('li');
      items.forEach(item => item.classList.remove('highlighted'));

      if (index >= 0 && index < items.length) {
        items[index].classList.add('highlighted');
        items[index].scrollIntoView({ block: 'nearest' });
      }
    }

    // Event listeners
    input.addEventListener('input', (e) => {
      const suggestions = filterGrades(e.target.value);
      showSuggestions(suggestions);
    });

    input.addEventListener('keydown', (e) => {
      const items = suggestionsList.querySelectorAll('li');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentFocus = Math.min(currentFocus + 1, items.length - 1);
        highlightSuggestion(currentFocus);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentFocus = Math.max(currentFocus - 1, 0);
        highlightSuggestion(currentFocus);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentFocus >= 0 && items[currentFocus]) {
          const grade = items[currentFocus].getAttribute('data-grade');
          selectGrade(grade);
        } else {
          // Try exact match
          const exactMatch = availableGrades.find(g =>
            g.toLowerCase() === input.value.toLowerCase()
          );
          if (exactMatch) {
            selectGrade(exactMatch);
          }
        }
      } else if (e.key === 'Escape') {
        hideSuggestions();
      }
    });

    // Click on suggestion
    suggestionsList.addEventListener('click', (e) => {
      const target = e.target;
      if (target.tagName === 'LI') {
        const grade = target.getAttribute('data-grade');
        selectGrade(grade);
      }
    });

    // Click outside to close
    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !suggestionsList.contains(e.target)) {
        hideSuggestions();
      }
    });
  })();
</script>
