---
/**
 * Full Conversion Reference Table
 * Comprehensive grade conversion chart (collapsible)
 */

import ConfidenceIndicator from './ConfidenceIndicator.astro';

interface Props {
  gradeData: Record<string, any>;
  title: string;
  id?: string;
}

const { gradeData, title, id = 'conversion-table' } = Astro.props;

// Extract all grades
const grades = Object.values(gradeData);

// Get unique systems from first grade
const systems = grades.length > 0 ? Object.keys(grades[0].equivalents) : [];

// Format system names
const formatSystemName = (system: string) => {
  return system
    .split('_')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};
---

<div class="conversion-table-container mt-12 mb-8">
  <!-- Collapsible header -->
  <button
    type="button"
    class="table-toggle w-full flex items-center justify-between p-5 bg-ivory border-2 border-gray-200 rounded-lg hover:border-sage hover:bg-white transition-colors text-left"
    aria-expanded="false"
    aria-controls={id}
  >
    <div>
      <h2 class="text-2xl font-bold text-granite">{title}</h2>
      <p class="text-sm text-gray-600 mt-1">Click to view full conversion reference chart</p>
    </div>

    <svg
      class="chevron w-6 h-6 text-gray-500 transform transition-transform"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 9l-7 7-7-7"
      />
    </svg>
  </button>

  <!-- Table content (hidden by default) -->
  <div id={id} class="table-content hidden mt-4 overflow-x-auto bg-white border-2 border-gray-200 rounded-lg">
    <table class="w-full">
      <thead>
        <tr class="bg-sage text-white">
          <th class="px-4 py-3 text-left font-semibold text-sm">Grade</th>
          {systems.map(system => (
            <th class="px-4 py-3 text-left font-semibold text-sm">
              {formatSystemName(system)}
            </th>
          ))}
          <th class="px-4 py-3 text-left font-semibold text-sm">Skill Level</th>
          <th class="px-4 py-3 text-center font-semibold text-sm">Accuracy</th>
        </tr>
      </thead>
      <tbody>
        {grades.map((grade, index) => {
          // Determine row background based on skill level
          const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

          // Get average confidence level for the row
          const confidenceLevels = Object.values(grade.equivalents).map((eq: any) => eq.confidence);
          const avgConfidence = confidenceLevels[0]; // Use first system's confidence as representative

          return (
            <tr class={`${rowBg} hover:bg-ivory transition-colors border-t border-gray-200`}>
              <!-- Primary grade -->
              <td class="px-4 py-3 font-bold text-granite whitespace-nowrap">
                {grade.display}
              </td>

              <!-- Equivalent grades -->
              {systems.map(system => {
                const equivalent = grade.equivalents[system];
                return (
                  <td class="px-4 py-3 text-gray-700 whitespace-nowrap">
                    {equivalent.value}
                    {equivalent.note && (
                      <span class="text-xs text-gray-500 ml-1" title={equivalent.note}>*</span>
                    )}
                  </td>
                );
              })}

              <!-- Skill level -->
              <td class="px-4 py-3">
                <span class={`skill-badge px-2 py-1 rounded-full text-xs font-medium ${
                  grade.skill_level === 'Beginner' ? 'bg-blue-100 text-blue-800' :
                  grade.skill_level === 'Intermediate' ? 'bg-purple-100 text-purple-800' :
                  grade.skill_level === 'Advanced' ? 'bg-orange-100 text-orange-800' :
                  'bg-red-100 text-red-800'
                }`}>
                  {grade.skill_level}
                </span>
              </td>

              <!-- Confidence indicator -->
              <td class="px-4 py-3 text-center">
                <ConfidenceIndicator level={avgConfidence} showLabel={false} size="sm" />
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>

    <!-- Legend -->
    <div class="legend p-4 bg-gray-50 border-t-2 border-gray-200">
      <p class="text-sm font-semibold text-granite mb-2">Legend:</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-700">
        <div class="flex items-center gap-2">
          <ConfidenceIndicator level="high" showLabel={false} size="sm" />
          <span>High Confidence - Well-established conversion</span>
        </div>
        <div class="flex items-center gap-2">
          <ConfidenceIndicator level="medium" showLabel={false} size="sm" />
          <span>Approximate - Some regional variation</span>
        </div>
        <div class="flex items-center gap-2">
          <ConfidenceIndicator level="low" showLabel={false} size="sm" />
          <span>Subjective - Route-dependent</span>
        </div>
        <div class="flex items-center gap-2">
          <ConfidenceIndicator level="very-low" showLabel={false} size="sm" />
          <span>Highly Variable - Elite grades</span>
        </div>
      </div>
      <p class="text-xs text-gray-600 mt-3">
        * Indicates regional variations or special notes. Hover/tap for details.
      </p>
    </div>
  </div>
</div>

<style>
  .table-toggle[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  .table-content {
    animation: slideDown 300ms ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  table {
    border-collapse: collapse;
  }

  th, td {
    min-width: 80px;
  }

  @media (max-width: 768px) {
    th, td {
      font-size: 0.875rem;
      padding: 0.5rem;
    }

    .skill-badge {
      font-size: 0.625rem;
      padding: 0.25rem 0.5rem;
    }
  }

  @media print {
    .table-toggle {
      display: none;
    }

    .table-content {
      display: block !important;
    }
  }
</style>

<script define:vars={{ id }}>
  (function() {
    const toggle = document.querySelector('.table-toggle');
    const content = document.getElementById(id);

    toggle.addEventListener('click', () => {
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';

      if (isExpanded) {
        content.classList.add('hidden');
        toggle.setAttribute('aria-expanded', 'false');
      } else {
        content.classList.remove('hidden');
        toggle.setAttribute('aria-expanded', 'true');
      }
    });
  })();
</script>
