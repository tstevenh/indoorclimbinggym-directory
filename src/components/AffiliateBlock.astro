---
import { getRandomProducts, type Product } from '../data/affiliateProducts';

interface Props {
  title?: string;
  subtitle?: string;
  products?: Product[];
  variant?: 'horizontal' | 'vertical';
  count?: number;
  category?: string;
}

const {
  title = "Gear Up for Your Visit",
  subtitle = "Essential gear recommended for indoor climbing.",
  variant = "horizontal",
  count = 3,
  category,
  products = getRandomProducts(count, category)
} = Astro.props;

// Layout classes based on variant and count
let containerClasses = "grid grid-cols-1 md:grid-cols-3 gap-6";

if (variant === 'vertical') {
  containerClasses = "flex flex-col gap-4";
} else if (count >= 5) {
  // Adaptive grid for more products
  containerClasses = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6";
} else if (count === 4) {
  containerClasses = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6";
}

const cardClasses = variant === 'vertical'
  ? "flex flex-row md:flex-col h-24 md:h-auto" // Compact row on small, stack on vertical usage
  : "flex flex-col h-full";

const imageContainerClasses = variant === 'vertical'
  ? "w-24 md:w-full h-full md:h-48 flex-shrink-0"
  : "h-48 w-full";
---

{products && products.length > 0 && (
<section class={`bg-white rounded-lg shadow-md p-6 border border-gray-100 my-8 ${variant === 'vertical' ? 'max-w-xs mx-auto' : ''}`}>
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-2">
    <div>
      <div role="heading" aria-level="2" class={`${variant === 'vertical' ? 'text-xl' : 'text-2xl'} font-bold text-granite flex items-center gap-2`}>
        <svg class="w-6 h-6 text-sage" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
        </svg>
        {title}
      </div>
      {subtitle && <p class="text-gray-600 text-sm mt-1">{subtitle}</p>}
    </div>
    <span class="text-[10px] text-gray-500 uppercase tracking-wider self-start md:self-center">
      Common picks
    </span>
  </div>

  <div class={containerClasses}>
    {products.map((product) => (
      <a 
        href={product.link} 
        target="_blank" 
        rel="noopener noreferrer sponsored"
        class={`group ${cardClasses} border border-gray-100 rounded-lg overflow-hidden hover:shadow-lg hover:border-sage/30 transition-all duration-300`}
      >
        <div class={`relative bg-gray-50 p-4 flex items-center justify-center overflow-hidden ${imageContainerClasses}`}>
          <img 
            src={product.imageUrl} 
            alt={product.name} 
            class="object-contain h-full w-full group-hover:scale-105 transition-transform duration-300 mix-blend-multiply"
            loading="lazy"
          />
          {product.badge && (
            <span class="absolute top-2 right-2 bg-sage text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm">
              {product.badge}
            </span>
          )}
        </div>
        
        <div class="p-4 flex flex-col flex-grow bg-white justify-between">
          <div>
            <div role="heading" aria-level="3" class={`font-bold text-granite group-hover:text-sage transition-colors mb-1 line-clamp-1 ${variant === 'vertical' ? 'text-sm' : ''}`}>
              {product.name}
            </div>
            <p class="text-gray-500 text-xs mb-2 line-clamp-2">
              {product.description}
            </p>
          </div>
          
          <div class="flex justify-between items-center pt-2 border-t border-gray-100 mt-auto">
            <span class="font-bold text-gray-900 text-sm">{product.price}</span>
            <span class="text-xs text-sage font-medium flex items-center gap-1 group-hover:translate-x-1 transition-transform">
              See details
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </span>
          </div>
        </div>
      </a>
    ))}
  </div>

  <div class="mt-6 text-center border-t border-gray-100 pt-4">
    <a href="/gear" class="inline-flex items-center gap-2 text-sm text-sage font-medium hover:text-sage/80 transition-colors group">
      View All Recommended Gear
      <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
      </svg>
    </a>
  </div>
</section>
)}