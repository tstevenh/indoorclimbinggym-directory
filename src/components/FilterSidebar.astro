---
/**
 * FilterSidebar Component
 * Filtering controls for gym search/browse pages
 */

interface Props {
  showLocationFilter?: boolean;
  showTypeFilter?: boolean;
  showAmenityFilter?: boolean;
  showPriceFilter?: boolean;
  showRatingFilter?: boolean;
}

const {
  showLocationFilter = true,
  showTypeFilter = true,
  showAmenityFilter = true,
  showPriceFilter = true,
  showRatingFilter = true,
} = Astro.props;

// Import API helper and utils
import { fetchGyms } from '../config/api';
import { getStateCode } from '../utils/states';

// Fetch gyms and build filter data
let cities: string[] = [];
let states: string[] = [];
const stateCitiesMap: Record<string, string[]> = {};

try {
  const gyms = await fetchGyms();
  
  // build state -> cities map
  gyms.forEach(gym => {
    if (gym.region && gym.city) {
      const stateCode = getStateCode(gym.region).toLowerCase();
      
      if (!stateCitiesMap[stateCode]) {
        stateCitiesMap[stateCode] = [];
      }
      // Add city if not already present
      if (!stateCitiesMap[stateCode].includes(gym.city)) {
        stateCitiesMap[stateCode].push(gym.city);
      }
    }
  });

  // Sort cities within each state
  Object.values(stateCitiesMap).forEach(cityList => cityList.sort());

  // Get all unique states and cities for initial render
  states = [...new Set(gyms.map(g => g.region).filter(Boolean))].sort();
  cities = [...new Set(gyms.map(g => g.city).filter(Boolean))].sort();

} catch (error) {
  console.error('Failed to fetch gym data for filters:', error);
  // Fallback
  cities = ['Austin', 'Denver', 'Los Angeles', 'New York', 'Seattle'];
  states = ['California', 'Colorado', 'New York', 'Texas', 'Washington'];
}

// Get current URL params to pre-populate form
const currentParams = Astro.url.searchParams;

// Climbing types
const climbingTypes = [
  { value: 'bouldering', label: 'Bouldering' },
  { value: 'top_rope', label: 'Top Rope' },
  { value: 'lead', label: 'Lead' },
  { value: 'speed', label: 'Speed' },
];

// Common amenities
const amenities = [
  { value: 'showers', label: 'Showers' },
  { value: 'lockers', label: 'Lockers' },
  { value: 'cafe', label: 'Cafe' },
  { value: 'wifi', label: 'WiFi' },
  { value: 'parking', label: 'Parking' },
  { value: 'sauna', label: 'Sauna' },
  { value: 'kids_zone', label: 'Kids Zone' },
  { value: 'pro_shop', label: 'Pro Shop' },
];
---

<aside class="bg-white rounded-lg shadow-md p-6 sticky top-4">
  <h2 class="text-xl font-bold text-granite mb-6">Filter Gyms</h2>

  <!-- Pass the map to client-side JS via data attribute on the form -->
  <form 
    id="filter-form" 
    method="get" 
    action="/search" 
    class="space-y-6"
    data-state-cities={JSON.stringify(stateCitiesMap)}
  >
    <!-- Location Filter -->
    {showLocationFilter && (
      <div class="filter-section">
        <h3 class="font-semibold text-granite mb-3">Location</h3>

        <div class="mb-3">
          <label for="state-select" class="block text-sm text-gray-600 mb-2">
            State
          </label>
          <select
            id="state-select"
            name="state"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sage focus:outline-none focus:ring-2 focus:ring-sage focus:ring-opacity-50"
          >
            <option value="">All States</option>
            {states.map(state => {
              const stateCode = getStateCode(state).toLowerCase();
              const isSelected = currentParams.get('state')?.toLowerCase() === stateCode;
              return (
                <option value={stateCode} selected={isSelected}>{state}</option>
              );
            })}
          </select>
        </div>

        <div>
          <label for="city-select" class="block text-sm text-gray-600 mb-2">
            City
          </label>
          <select
            id="city-select"
            name="city"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sage focus:outline-none focus:ring-2 focus:ring-sage focus:ring-opacity-50"
          >
            <option value="">All Cities</option>
            {cities.map(city => {
              const isSelected = currentParams.get('city')?.toLowerCase() === city.toLowerCase();
              return (
                <option value={city.toLowerCase()} selected={isSelected}>{city}</option>
              );
            })}
          </select>
        </div>
      </div>
    )}

    <!-- Climbing Type Filter -->
    {showTypeFilter && (
      <div class="filter-section border-t border-gray-200 pt-6">
        <h3 class="font-semibold text-granite mb-3">Climbing Type</h3>
        <div class="space-y-2">
          {climbingTypes.map(type => {
            const currentTypes = currentParams.get('climbing_types')?.split(',') || [];
            const isChecked = currentTypes.includes(type.value);
            return (
              <label class="flex items-center cursor-pointer group">
                <input
                  type="checkbox"
                  name="climbing_types"
                  value={type.value}
                  checked={isChecked}
                  class="w-4 h-4 text-sage border-gray-300 rounded focus:ring-sage"
                />
                <span class="ml-2 text-sm text-gray-700 group-hover:text-sage">
                  {type.label}
                </span>
              </label>
            );
          })}
        </div>
      </div>
    )}

    <!-- Amenities Filter -->
    {showAmenityFilter && (
      <div class="filter-section border-t border-gray-200 pt-6">
        <h3 class="font-semibold text-granite mb-3">Amenities</h3>
        <div class="space-y-2">
          {amenities.map(amenity => {
            const currentAmenities = currentParams.get('amenities')?.split(',') || [];
            const isChecked = currentAmenities.includes(amenity.value);
            return (
              <label class="flex items-center cursor-pointer group">
                <input
                  type="checkbox"
                  name="amenities"
                  value={amenity.value}
                  checked={isChecked}
                  class="w-4 h-4 text-sage border-gray-300 rounded focus:ring-sage"
                />
                <span class="ml-2 text-sm text-gray-700 group-hover:text-sage">
                  {amenity.label}
                </span>
              </label>
            );
          })}
        </div>
      </div>
    )}

    <!-- Price Range Filter -->
    {showPriceFilter && (
      <div class="filter-section border-t border-gray-200 pt-6">
        <h3 class="font-semibold text-granite mb-3">Day Pass Price</h3>
        <div class="space-y-3">
          <div>
            <label for="min-price" class="block text-sm text-gray-600 mb-1">
              Min Price ($)
            </label>
            <input
              type="number"
              id="min-price"
              name="min_price"
              min="0"
              max="100"
              value={currentParams.get('min_price') || ''}
              placeholder="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sage focus:outline-none focus:ring-2 focus:ring-sage focus:ring-opacity-50"
            />
          </div>
          <div>
            <label for="max-price" class="block text-sm text-gray-600 mb-1">
              Max Price ($)
            </label>
            <input
              type="number"
              id="max-price"
              name="max_price"
              min="0"
              max="100"
              value={currentParams.get('max_price') || ''}
              placeholder="100"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sage focus:outline-none focus:ring-2 focus:ring-sage focus:ring-opacity-50"
            />
          </div>
        </div>
      </div>
    )}

    <!-- Rating Filter -->
    {showRatingFilter && (
      <div class="filter-section border-t border-gray-200 pt-6">
        <h3 class="font-semibold text-granite mb-3">Minimum Rating</h3>
        <div class="space-y-2">
          {[4.5, 4.0, 3.5, 3.0].map(rating => {
            const currentRating = currentParams.get('min_rating');
            const isChecked = currentRating === rating.toString();
            return (
              <label class="flex items-center cursor-pointer group">
                <input
                  type="radio"
                  name="min_rating"
                  value={rating}
                  checked={isChecked}
                  class="w-4 h-4 text-sage border-gray-300 focus:ring-sage"
                />
                <span class="ml-2 text-sm text-gray-700 group-hover:text-sage flex items-center">
                  {rating}
                  <svg class="w-4 h-4 text-yellow-400 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                  & up
                </span>
              </label>
            );
          })}
        </div>
      </div>
    )}

    <!-- Special Features -->
    <div class="filter-section border-t border-gray-200 pt-6">
      <h3 class="font-semibold text-granite mb-3">Special Features</h3>
      <div class="space-y-2">
        <label class="flex items-center cursor-pointer group">
          <input
            type="checkbox"
            name="beginner_friendly"
            value="true"
            checked={currentParams.get('beginner_friendly') === 'true'}
            class="w-4 h-4 text-sage border-gray-300 rounded focus:ring-sage"
          />
          <span class="ml-2 text-sm text-gray-700 group-hover:text-sage">
            Beginner Friendly
          </span>
        </label>
        <label class="flex items-center cursor-pointer group">
          <input
            type="checkbox"
            name="student_discount"
            value="true"
            checked={currentParams.get('student_discount') === 'true'}
            class="w-4 h-4 text-sage border-gray-300 rounded focus:ring-sage"
          />
          <span class="ml-2 text-sm text-gray-700 group-hover:text-sage">
            Student Discount
          </span>
        </label>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="pt-6 space-y-3">
      <button
        type="submit"
        class="w-full bg-sage text-white py-3 rounded-lg font-medium hover:bg-opacity-90 transition-colors"
      >
        Apply Filters
      </button>
      <a
        href="/search/"
        class="block w-full bg-gray-200 text-granite py-3 rounded-lg font-medium hover:bg-gray-300 transition-colors text-center"
      >
        Clear All Filters
      </a>
    </div>
  </form>
</aside>

<script>
  // Handle form submission and city filtering
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('filter-form') as HTMLFormElement;
    const stateSelect = document.getElementById('state-select') as HTMLSelectElement;
    const citySelect = document.getElementById('city-select') as HTMLSelectElement;

    if (form && stateSelect && citySelect) {
      // Get state-cities map from data attribute
      const stateCitiesMap = JSON.parse(form.dataset.stateCities || '{}');
      
      // Store initial city selection (from server render)
      const initialCity = citySelect.value;

      // Function to update city options
      const updateCityOptions = () => {
        const selectedState = stateSelect.value;
        const currentCity = citySelect.value;
        
        // Clear current options
        citySelect.innerHTML = '<option value="">All Cities</option>';
        
        let citiesToShow = [];
        
        if (selectedState && stateCitiesMap[selectedState]) {
          // Show only cities for selected state
          citiesToShow = stateCitiesMap[selectedState];
        } else {
          // Show all cities (merge all arrays)
          const allCitiesSet = new Set();
          Object.values(stateCitiesMap).forEach((cities: any) => {
            cities.forEach((city: string) => allCitiesSet.add(city));
          });
          citiesToShow = Array.from(allCitiesSet).sort();
        }
        
        // Add options
        citiesToShow.forEach((city: any) => {
          const option = document.createElement('option');
          option.value = city.toLowerCase();
          option.textContent = city;
          
          // Preserve selection if it's valid for the new list
          // Check against lowercase value for comparison
          if (city.toLowerCase() === currentCity) {
            option.selected = true;
          }
          
          citySelect.appendChild(option);
        });
      };

      // Listen for state changes
      stateSelect.addEventListener('change', updateCityOptions);
      
      // Also run on load if there's a state selected but we need to ensure consistency
      // (Server rendering handles the initial "selected" attribute correctly, but this ensures subsequent interactions work)
      // Actually, server side renders filtered lists only if logic was there. 
      // Since we simplified server render to show "All Cities" initially unless filtered,
      // let's run this on load ONLY if a state is selected to filter the initial list if it wasn't filtered by server.
      // The server code above renders ALL cities initially. So we should run this to filter them if a state is pre-selected.
      if (stateSelect.value) {
        // Save current city value before update wipes it (captured in initialCity)
        // We need to manually re-select it after update
        updateCityOptions();
        if (initialCity) {
           citySelect.value = initialCity;
        }
      }

      // Handle Form Submit
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams();

        // Handle text search (preserve from existing URL if present)
        const currentUrl = new URL(window.location.href);
        const currentQuery = currentUrl.searchParams.get('q');
        if (currentQuery) {
          params.set('q', currentQuery);
        }

        // Collect all form values
        const climbingTypes: string[] = [];
        const amenities: string[] = [];

        for (const [key, value] of formData.entries()) {
          const valueStr = value.toString();

          if (!valueStr) continue; // Skip empty values

          if (key === 'climbing_types') {
            climbingTypes.push(valueStr);
          } else if (key === 'amenities') {
            amenities.push(valueStr);
          } else {
            // For other fields, just add them
            params.set(key, valueStr);
          }
        }

        // Add comma-separated arrays
        if (climbingTypes.length > 0) {
          params.set('climbing_types', climbingTypes.join(','));
        }
        if (amenities.length > 0) {
          params.set('amenities', amenities.join(','));
        }

        // Navigate to search page with params
        window.location.href = `/search?${params.toString()}`;
      });
    }
  });
</script>