---
/**
 * Categories Index Page
 * Central hub for all climbing gym category pages
 * Auto-generates categories based on what pages actually exist
 * Matches logic from [category].astro dynamic route
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { fetchGyms } from '../../config/api';
import gymsJsonData from '../../data/gyms.json';

export const prerender = true;

// Fetch gyms from API (with JSON fallback)
let gymsData;
try {
  gymsData = await fetchGyms();
} catch (error) {
  console.log('API unavailable, using local JSON data');
  gymsData = gymsJsonData;
}

/**
 * Helper: Get icon for amenity type
 */
function getIconForAmenity(amenity: string): string {
  const iconMap: Record<string, string> = {
    'cafe': '',
    'wifi': '',
    'showers': '',
    'parking': '',
    'pro_shop': '',
    'sauna': '',
    'kids_zone': '',
    'yoga': '',
    'lockers': '',
    'weights': '',
  };
  return iconMap[amenity] || '';
}

/**
 * Helper: Get icon for climbing type
 */
function getIconForClimbingType(type: string): string {
  const iconMap: Record<string, string> = {
    'bouldering': '',
    'top_rope': '',
    'lead': '',
    'speed': '',
    'auto_belay': '',
  };
  return iconMap[type] || '';
}

/**
 * Helper: Format text (underscore to space, capitalize)
 */
function formatText(text: string): string {
  return text.replace(/_/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

// ========================================
// STATIC CATEGORIES (Have actual page files)
// ========================================
const staticCategories = [
  {
    name: 'Best for Beginners',
    slug: 'best-climbing-gyms-for-beginners',
    description: 'Welcoming gyms perfect for first-time climbers with intro classes',
    icon: '',
    count: gymsData.filter(g => g.beginner_friendly === true).length,
    category: 'experience',
  },
  {
    name: 'Best Bouldering Gyms',
    slug: 'best-bouldering-climbing-gyms',
    description: 'Top-rated facilities focused on bouldering excellence',
    icon: '',
    count: gymsData.filter(g => g.climbing_types?.includes('bouldering')).length,
    category: 'specialty',
  },
  {
    name: 'Gyms with Sauna',
    slug: 'climbing-gyms-with-sauna',
    description: 'Recovery-focused gyms with sauna amenities',
    icon: '',
    count: gymsData.filter(g => g.amenities?.includes('sauna')).length,
    category: 'amenity',
  },
  {
    name: 'Gyms with Kids Zone',
    slug: 'climbing-gyms-with-kids-zone',
    description: 'Family-friendly gyms with dedicated kids areas',
    icon: '',
    count: gymsData.filter(g => g.amenities?.includes('kids_zone')).length,
    category: 'amenity',
  },
  {
    name: 'Affordable Gyms',
    slug: 'affordable-climbing-gyms',
    description: 'Budget-friendly climbing gyms with great value',
    icon: '',
    count: gymsData.filter(g => g.day_pass_price_local <= 20).length,
    category: 'value',
  },
];

// ========================================
// DYNAMIC CATEGORIES (Generated by [category].astro)
// This MUST match the exact logic in [category].astro
// ========================================

// Parse all amenities and climbing types from data
const allAmenities = new Set<string>();
const allClimbingTypes = new Set<string>();

gymsData.forEach(gym => {
  gym.amenities?.split('|').forEach(a => allAmenities.add(a.trim()));
  gym.climbing_types?.split('|').forEach(ct => allClimbingTypes.add(ct.trim()));
});

// Categories to skip (have static pages)
const skipAmenities = ['sauna', 'kids_zone'];
const skipClimbingTypes = ['bouldering'];

const dynamicCategories = [];

// Generate amenity-based categories (only if 3+ gyms have it)
for (const amenity of allAmenities) {
  if (skipAmenities.includes(amenity)) continue;

  const matchingGyms = gymsData.filter(g => g.amenities?.includes(amenity));
  if (matchingGyms.length >= 3) {
    dynamicCategories.push({
      name: `Gyms with ${formatText(amenity)}`,
      slug: `climbing-gyms-with-${amenity.replace(/_/g, '-')}`,
      description: `Climbing gyms offering ${formatText(amenity).toLowerCase()} amenities`,
      icon: getIconForAmenity(amenity),
      count: matchingGyms.length,
      category: 'amenity',
    });
  }
}

// Generate climbing type-based categories (only if 3+ gyms have it)
for (const climbingType of allClimbingTypes) {
  if (skipClimbingTypes.includes(climbingType)) continue;

  const matchingGyms = gymsData.filter(g => g.climbing_types?.includes(climbingType));
  if (matchingGyms.length >= 3) {
    dynamicCategories.push({
      name: `Best ${formatText(climbingType)} Climbing Gyms`,
      slug: `best-${climbingType.replace(/_/g, '-')}-climbing-gyms`,
      description: `Top facilities specializing in ${formatText(climbingType).toLowerCase()} climbing`,
      icon: getIconForClimbingType(climbingType),
      count: matchingGyms.length,
      category: 'climbing-type',
    });
  }
}

// ========================================
// COMBINE & FILTER CATEGORIES
// ========================================

// Combine all categories
const allCategories = [...staticCategories, ...dynamicCategories];

// Filter out any with 0 gyms (should not happen, but safety check)
const categories = allCategories.filter(cat => cat.count > 0);

// Calculate totals
const totalCategories = categories.length;
const totalGyms = gymsData.length;
const avgRating = (gymsData.reduce((sum, gym) => sum + gym.rating, 0) / gymsData.length).toFixed(1);

// SEO
const pageUrl = 'https://www.indoorclimbinggym.com/categories';
const pageTitle = 'Climbing Gym Categories | Find Your Perfect Gym';
const pageDescription = 'Browse climbing gyms by category: beginner-friendly, bouldering, amenities, and more. Find the perfect gym match for your climbing style and needs.';

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', url: 'https://www.indoorclimbinggym.com' },
  { label: 'Categories', url: pageUrl },
];

// Schema markup - Collection Page
const schema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: pageTitle,
  description: pageDescription,
  url: pageUrl,
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: totalCategories,
    itemListElement: categories.map((cat, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: cat.name,
      url: `${pageUrl}/${cat.slug}`,
    })),
  },
};
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonical={pageUrl}
  keywords={['climbing gym categories', 'find climbing gyms', 'climbing gym types', 'bouldering gyms', 'indoor climbing', 'rock climbing gyms', 'climbing gym amenities']}
  schema={schema}
  breadcrumbs={breadcrumbs}
>
  <!-- Breadcrumb Navigation -->
  <nav class="text-sm mb-6" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2">
      {breadcrumbs.map((crumb, index) => (
        <li class="flex items-center gap-2">
          {index > 0 && <span class="text-gray-400">/</span>}
          {index === breadcrumbs.length - 1 ? (
            <span class="text-sage font-medium">{crumb.label}</span>
          ) : (
            <a href={crumb.url} class="text-granite hover:text-sage">
              {crumb.label}
            </a>
          )}
        </li>
      ))}
    </ol>
  </nav>

  <!-- Hero Section -->
  <header class="mb-12">
    <h1 class="text-4xl md:text-5xl font-bold text-granite mb-4">
      Browse Climbing Gyms by Category
    </h1>
    <p class="text-xl text-gray-700 mb-6 leading-relaxed max-w-4xl">
      Find your ideal climbing gym by exploring our comprehensive categories. Whether you're a beginner looking for welcoming instruction, a boulderer seeking challenging problems, or someone who values specific amenities like saunas or cafes, our category system helps you discover gyms perfectly matched to your preferences. Each category showcases gyms filtered by climbing types, experience levels, amenities, and special features, making it easy to find exactly what you're looking for in your next climbing destination.
    </p>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-white p-6 rounded-lg shadow-md">
      <div>
        <p class="text-3xl font-bold text-sage">{totalCategories}</p>
        <p class="text-sm text-gray-600">Categories</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-sage">{totalGyms}</p>
        <p class="text-sm text-gray-600">Total Gyms</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-sage">{avgRating}★</p>
        <p class="text-sm text-gray-600">Average Rating</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-sage">14</p>
        <p class="text-sm text-gray-600">Unique Filters</p>
      </div>
    </div>
  </header>

  <!-- Special Features Section -->
  <section class="mb-16">
    <h2 class="text-3xl font-bold text-granite mb-6">Special Features</h2>
    <p class="text-gray-700 mb-6 leading-relaxed">
      Discover climbing gyms with unique characteristics and specialized offerings that cater to specific climbing preferences and skill levels.
    </p>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {categories.filter(cat => ['experience', 'value', 'specialty'].includes(cat.category)).map(category => (
        <a
          href={`/categories/${category.slug}/1`}
          class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 border-2 border-transparent hover:border-sage group"
        >
          <div>
            <h3 class="text-xl font-bold text-granite group-hover:text-sage mb-2 transition-colors">
              {category.name}
            </h3>
            <p class="text-sm text-gray-600 mb-3">{category.description}</p>
            <div class="flex items-center justify-between">
              <span class="text-sage font-bold text-lg">{category.count} gyms</span>
              <span class="text-sage text-sm group-hover:translate-x-1 transition-transform inline-block">
                View →
              </span>
            </div>
          </div>
        </a>
      ))}
    </div>
  </section>

  <!-- By Climbing Type Section -->
  <section class="mb-16">
    <h2 class="text-3xl font-bold text-granite mb-6">By Climbing Type</h2>
    <p class="text-gray-700 mb-6 leading-relaxed">
      Find gyms specializing in your preferred climbing discipline, whether you're into top rope, lead climbing, or speed climbing.
    </p>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {categories.filter(cat => cat.category === 'climbing-type').map(category => (
        <a
          href={`/categories/${category.slug}/1`}
          class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 border-2 border-transparent hover:border-sage group"
        >
          <div>
            <h3 class="text-xl font-bold text-granite group-hover:text-sage mb-2 transition-colors">
              {category.name}
            </h3>
            <p class="text-sm text-gray-600 mb-3">{category.description}</p>
            <div class="flex items-center justify-between">
              <span class="text-sage font-bold text-lg">{category.count} gyms</span>
              <span class="text-sage text-sm group-hover:translate-x-1 transition-transform inline-block">
                View →
              </span>
            </div>
          </div>
        </a>
      ))}
    </div>
  </section>

  <!-- By Amenities Section -->
  <section class="mb-16">
    <h2 class="text-3xl font-bold text-granite mb-6">By Amenities</h2>
    <p class="text-gray-700 mb-6 leading-relaxed">
      Browse gyms based on the amenities that matter most to you, from recovery facilities like saunas to convenience features like cafes and parking.
    </p>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      {categories.filter(cat => cat.category === 'amenity').map(category => (
        <a
          href={`/categories/${category.slug}/1`}
          class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 border-2 border-transparent hover:border-sage group"
        >
          <div>
            <h3 class="text-xl font-bold text-granite group-hover:text-sage mb-2 transition-colors">
              {category.name}
            </h3>
            <p class="text-sm text-gray-600 mb-3">{category.description}</p>
            <div class="flex items-center justify-between">
              <span class="text-sage font-bold text-lg">{category.count} gyms</span>
              <span class="text-sage text-sm group-hover:translate-x-1 transition-transform inline-block">
                View →
              </span>
            </div>
          </div>
        </a>
      ))}
    </div>
  </section>

  <!-- About Categories Section -->
  <section class="mb-16 bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold text-granite mb-6">How to Choose the Right Category</h2>

    <div class="prose prose-lg max-w-none">
      <p class="text-gray-700 mb-6 leading-relaxed">
        Our category system organizes climbing gyms by the features and characteristics that matter most to climbers. Whether you're prioritizing specific amenities, climbing disciplines, or experience levels, these curated collections help you quickly identify gyms that match your exact needs. Each category page provides detailed comparisons, ratings, and comprehensive information to support your decision-making process.
      </p>

      <h3 class="text-2xl font-bold text-granite mb-4 mt-8">Experience-Based Categories</h3>
      <p class="text-gray-700 mb-4 leading-relaxed">
        Start your search with experience-based categories if you're new to climbing or helping someone begin their journey. Our <strong>Best for Beginners</strong> category highlights gyms that excel at welcoming newcomers with comprehensive intro classes, patient instruction, and supportive communities. These facilities understand that first impressions matter and create environments specifically designed to build confidence. For experienced climbers, the <strong>Top Rated Gyms</strong> category showcases facilities with consistent 4.5+ star ratings, indicating exceptional route setting, maintenance, and member satisfaction.
      </p>

      <h3 class="text-2xl font-bold text-granite mb-4 mt-8">Climbing Style Categories</h3>
      <p class="text-gray-700 mb-4 leading-relaxed">
        Different climbing disciplines require different facilities and expertise. <strong>Best Bouldering Gyms</strong> focuses on facilities that prioritize boulder problems with creative setting, quality holds, and ideal wall angles. For rope climbers, our <strong>Top Rope Gyms</strong> and <strong>Lead Climbing Gyms</strong> categories identify facilities with tall walls, diverse route selections, and proper safety systems. Athletes training for competitions will appreciate the <strong>Speed Climbing Gyms</strong> category, featuring the specialized equipment needed for this Olympic discipline.
      </p>

      <h3 class="text-2xl font-bold text-granite mb-4 mt-8">Amenity-Based Categories</h3>
      <p class="text-gray-700 mb-4 leading-relaxed">
        Modern climbing gyms offer far more than just walls. Our amenity categories help you find facilities that support your complete lifestyle. <strong>Gyms with Sauna</strong> cater to climbers prioritizing recovery with heat therapy after intense sessions. <strong>Gyms with Cafe</strong> serve as community hubs where you can work remotely or socialize between climbs. Families should explore <strong>Gyms with Kids Zone</strong> for facilities that welcome young climbers with dedicated programming. <strong>Gyms with WiFi</strong> appeal to digital nomads and remote workers who want to blend productivity with training.
      </p>

      <h3 class="text-2xl font-bold text-granite mb-4 mt-8">Practical Convenience Categories</h3>
      <p class="text-gray-700 mb-4 leading-relaxed">
        Logistics matter when choosing where to climb regularly. <strong>Gyms with Parking</strong> identifies facilities offering convenient vehicle access, essential in car-dependent areas. <strong>Gyms with Showers</strong> enables before-work or lunch climbing sessions without compromising your professional appearance. <strong>Gyms with Pro Shop</strong> provides one-stop shopping for gear needs, perfect when you need last-minute replacements or want expert advice while selecting equipment upgrades.
      </p>

      <h3 class="text-2xl font-bold text-granite mb-4 mt-8">Using Multiple Categories</h3>
      <p class="text-gray-700 mb-4 leading-relaxed">
        The most effective approach combines multiple categories to narrow your options. A parent new to climbing might start with "Best for Beginners" then filter through "Gyms with Kids Zone" to find family-friendly options with excellent instruction. A remote worker passionate about bouldering could combine "Best Bouldering Gyms" with "Gyms with Wifi" and "Gyms with Cafe" to find their ideal third workplace. Browse multiple categories to discover gyms meeting all your criteria rather than just one aspect.
      </p>
    </div>
  </section>

  <!-- Popular Cities Section -->
  <section class="mb-16">
    <h2 class="text-3xl font-bold text-granite mb-6">Popular Climbing Cities</h2>
    <p class="text-gray-700 mb-6">
      Explore climbing gyms in some of the most popular climbing destinations across the United States.
    </p>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
      <a href="/washington/seattle/1" class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
        <p class="font-bold text-granite hover:text-sage">Seattle</p>
        <p class="text-sm text-gray-600">Washington</p>
      </a>
      <a href="/texas/austin/1" class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
        <p class="font-bold text-granite hover:text-sage">Austin</p>
        <p class="text-sm text-gray-600">Texas</p>
      </a>
      <a href="/colorado/denver/1" class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
        <p class="font-bold text-granite hover:text-sage">Denver</p>
        <p class="text-sm text-gray-600">Colorado</p>
      </a>
      <a href="/new-york/new-york/1" class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
        <p class="font-bold text-granite hover:text-sage">New York</p>
        <p class="text-sm text-gray-600">New York</p>
      </a>
      <a href="/california/los-angeles/1" class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
        <p class="font-bold text-granite hover:text-sage">Los Angeles</p>
        <p class="text-sm text-gray-600">California</p>
      </a>
      <a href="/illinois/chicago/1" class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow text-center">
        <p class="font-bold text-granite hover:text-sage">Chicago</p>
        <p class="text-sm text-gray-600">Illinois</p>
      </a>
    </div>
  </section>

  <!-- Helpful Guides Section -->
  <section class="mb-16 bg-gradient-to-br from-sage/10 to-ivory rounded-lg p-8">
    <h2 class="text-3xl font-bold text-granite mb-6">Helpful Climbing Guides</h2>
    <p class="text-gray-700 mb-6">
      New to climbing or looking to improve? Check out our comprehensive guides for tips, techniques, and advice.
    </p>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <a
        href="/blog/beginners-guide-to-climbing-gyms"
        class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow group"
      >
        <h3 class="text-lg font-bold text-granite group-hover:text-sage mb-2">
          Complete Beginner's Guide
        </h3>
        <p class="text-sm text-gray-600">
          Everything you need to know before your first climbing gym visit
        </p>
      </a>

      <a
        href="/blog/what-to-wear-indoor-rock-climbing"
        class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow group"
      >
        <h3 class="text-lg font-bold text-granite group-hover:text-sage mb-2">
          What to Wear Climbing
        </h3>
        <p class="text-sm text-gray-600">
          Clothing and gear recommendations for indoor climbing
        </p>
      </a>

      <a
        href="/blog/bouldering-vs-rope-climbing"
        class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow group"
      >
        <h3 class="text-lg font-bold text-granite group-hover:text-sage mb-2">
          Bouldering vs Rope Climbing
        </h3>
        <p class="text-sm text-gray-600">
          Understand the differences and find your climbing style
        </p>
      </a>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="bg-sage text-white p-8 rounded-lg shadow-md text-center">
    <h2 class="text-3xl font-bold mb-4">Ready to Find Your Perfect Gym?</h2>
    <p class="text-lg mb-6">
      Browse by category or search all {totalGyms} climbing gyms in our comprehensive directory.
    </p>
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <a
        href="/search"
        class="inline-block bg-white text-sage px-8 py-3 rounded-lg font-bold hover:bg-opacity-90 transition-colors"
      >
        Search All Gyms
      </a>
      <a
        href="/blog"
        class="inline-block bg-transparent border-2 border-white text-white px-8 py-3 rounded-lg font-bold hover:bg-white hover:text-sage transition-colors"
      >
        Read Our Guides
      </a>
    </div>
  </section>
</BaseLayout>
