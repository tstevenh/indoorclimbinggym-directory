---
/**
 * Dynamic Category Pages
 * Auto-generates category pages from amenities and climbing types
 * Skips categories that have static pages (sauna, kids_zone, bouldering)
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import GymCard from '../../components/GymCard.astro';
import { generateSEO } from '../../utils/seo';
import { generateItemListSchema, generateFAQSchema } from '../../utils/schema';
import gymsData from '../../data/gyms.json';

export const prerender = true;

/**
 * Generate static paths for all dynamic category pages
 */
export async function getStaticPaths() {
  // Parse all amenities and climbing types from data
  const allAmenities = new Set<string>();
  const allClimbingTypes = new Set<string>();

  gymsData.forEach(gym => {
    gym.amenities?.split('|').forEach(a => allAmenities.add(a.trim()));
    gym.climbing_types?.split('|').forEach(ct => allClimbingTypes.add(ct.trim()));
  });

  // Categories to skip (have static pages)
  const skipAmenities = ['sauna', 'kids_zone'];
  const skipClimbingTypes = ['bouldering'];

  const categoryPaths = [];

  // Generate amenity-based pages (only if 3+ gyms have it)
  for (const amenity of allAmenities) {
    if (skipAmenities.includes(amenity)) continue;

    const matchingGyms = gymsData.filter(g => g.amenities?.includes(amenity));
    if (matchingGyms.length >= 3) {
      categoryPaths.push({
        params: { category: `climbing-gyms-with-${amenity.replace(/_/g, '-')}` },
        props: {
          type: 'amenity',
          value: amenity,
          gyms: matchingGyms.sort((a, b) => b.rating - a.rating)
        }
      });
    }
  }

  // Generate climbing type-based pages (only if 3+ gyms have it)
  for (const climbingType of allClimbingTypes) {
    if (skipClimbingTypes.includes(climbingType)) continue;

    const matchingGyms = gymsData.filter(g => g.climbing_types?.includes(climbingType));
    if (matchingGyms.length >= 3) {
      categoryPaths.push({
        params: { category: `best-${climbingType.replace(/_/g, '-')}-climbing-gyms` },
        props: {
          type: 'climbing_type',
          value: climbingType,
          gyms: matchingGyms.sort((a, b) => b.rating - a.rating)
        }
      });
    }
  }

  return categoryPaths;
}

// Get props from getStaticPaths
const { type, value, gyms } = Astro.props;

/**
 * Format text (convert underscore to space, capitalize)
 */
function formatText(text: string): string {
  return text.replace(/_/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

/**
 * Generate content based on category type
 */
const formattedValue = formatText(value);
const isAmenity = type === 'amenity';

// Page metadata
const pageTitle = isAmenity
  ? `Climbing Gyms with ${formattedValue}`
  : `Best ${formattedValue} Climbing Gyms`;

const categorySlug = Astro.params.category;
const pageUrl = `https://www.indoorclimbinggym.com/categories/${categorySlug}`;

const pageDescription = isAmenity
  ? `Find climbing gyms with ${formattedValue.toLowerCase()}. Compare ${gyms.length} gyms offering ${formattedValue.toLowerCase()} amenities with ratings, prices, and reviews.`
  : `Discover the best ${formattedValue.toLowerCase()} climbing gyms. Browse ${gyms.length} top-rated facilities specializing in ${formattedValue.toLowerCase()} climbing.`;

// SEO data
const keywords = isAmenity
  ? [`climbing gyms with ${formattedValue.toLowerCase()}`, `${formattedValue.toLowerCase()} climbing gym`, `climbing gym ${formattedValue.toLowerCase()}`]
  : [`${formattedValue.toLowerCase()} climbing gyms`, `best ${formattedValue.toLowerCase()} climbing`, `${formattedValue.toLowerCase()} climbing near me`];

const seoData = generateSEO({
  title: pageTitle,
  description: pageDescription,
  canonical: pageUrl,
  keywords: keywords,
});

// Stats
const avgRating = (gyms.reduce((sum, gym) => sum + gym.rating, 0) / gyms.length).toFixed(1);
const avgPrice = Math.round(gyms.reduce((sum, gym) => sum + gym.day_pass_price_local, 0) / gyms.length);
const priceRange = {
  min: Math.min(...gyms.map(g => g.day_pass_price_local)),
  max: Math.max(...gyms.map(g => g.day_pass_price_local)),
};

// Generate FAQs based on type
const faqs = isAmenity ? [
  {
    question: `Why are ${formattedValue.toLowerCase()} important at climbing gyms?`,
    answer: `${formattedValue} enhance the climbing experience by providing essential conveniences. These amenities make your visit more comfortable and allow you to focus on your climbing session without worrying about basic needs. Many climbers consider ${formattedValue.toLowerCase()} a key factor when choosing a gym.`,
  },
  {
    question: `How many climbing gyms offer ${formattedValue.toLowerCase()}?`,
    answer: `We've identified ${gyms.length} climbing gyms that offer ${formattedValue.toLowerCase()}. These facilities range across different cities and states, with an average rating of ${avgRating} stars. Gyms with ${formattedValue.toLowerCase()} typically charge between $${priceRange.min}-$${priceRange.max} for day passes.`,
  },
  {
    question: `Are ${formattedValue.toLowerCase()} included in membership fees?`,
    answer: `Most climbing gyms include access to ${formattedValue.toLowerCase()} as part of standard membership or day pass fees. However, policies can vary by facility. Some premium gyms may offer enhanced ${formattedValue.toLowerCase()} amenities as part of upgraded membership tiers. Always check with the specific gym for their policies.`,
  },
  {
    question: `What should I look for in climbing gyms with ${formattedValue.toLowerCase()}?`,
    answer: `When evaluating gyms with ${formattedValue.toLowerCase()}, consider the quality and availability of these amenities, especially during peak hours. Check reviews to see what other climbers say about the ${formattedValue.toLowerCase()} facilities. Also consider the gym's location, climbing variety, and overall rating alongside the ${formattedValue.toLowerCase()} amenities.`,
  },
] : [
  {
    question: `What is ${formattedValue.toLowerCase()} climbing?`,
    answer: `${formattedValue} climbing is a specific discipline in the sport that requires particular skills and equipment. These gyms specialize in providing quality ${formattedValue.toLowerCase()} climbing experiences with properly set routes, safety equipment, and trained staff. Whether you're a beginner or advanced climber, dedicated ${formattedValue.toLowerCase()} facilities offer the best environment for this climbing style.`,
  },
  {
    question: `How many gyms offer ${formattedValue.toLowerCase()} climbing?`,
    answer: `We've identified ${gyms.length} climbing gyms that offer ${formattedValue.toLowerCase()} climbing. These facilities have an average rating of ${avgRating} stars and day pass prices ranging from $${priceRange.min} to $${priceRange.max}. Most are located in major metropolitan areas with active climbing communities.`,
  },
  {
    question: `Do I need special equipment for ${formattedValue.toLowerCase()} climbing?`,
    answer: `${formattedValue} climbing may require specific equipment depending on the discipline. Most gyms offering ${formattedValue.toLowerCase()} climbing provide rental gear or have pro shops where you can purchase necessary equipment. First-time visitors can typically rent everything needed, and staff can guide you on proper equipment use and safety protocols.`,
  },
  {
    question: `Is ${formattedValue.toLowerCase()} climbing good for beginners?`,
    answer: `Many gyms with ${formattedValue.toLowerCase()} climbing welcome beginners and offer introductory classes. ${gyms.filter(g => g.beginner_friendly).length} of the ${gyms.length} gyms in this category are marked as beginner-friendly. Look for facilities that offer instruction, have beginner-appropriate routes, and maintain a supportive community atmosphere.`,
  },
  {
    question: `What's the average cost for ${formattedValue.toLowerCase()} climbing?`,
    answer: `Day passes at ${formattedValue.toLowerCase()} climbing gyms average around $${avgPrice}, with prices ranging from $${priceRange.min} to $${priceRange.max}. Monthly memberships typically offer better value for regular climbers. Many gyms also offer student discounts, punch cards, and family packages to make ${formattedValue.toLowerCase()} climbing more affordable.`,
  },
];

// Generate schemas
const itemListSchema = generateItemListSchema(
  gyms,
  pageTitle,
  pageUrl
);

const faqSchema = generateFAQSchema(faqs);

const combinedSchema = {
  '@context': 'https://schema.org',
  '@graph': [itemListSchema, faqSchema],
};

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', url: '/' },
  { label: 'Categories', url: '/categories' },
  { label: pageTitle, url: `/categories/${categorySlug}` },
];

// Generate intro paragraph based on type
const introText = isAmenity
  ? `Finding a climbing gym with ${formattedValue.toLowerCase()} can significantly enhance your training experience. These ${gyms.length} facilities understand that modern climbers value convenience and comfort alongside great climbing. Whether you're looking for post-session amenities or essential conveniences, gyms with ${formattedValue.toLowerCase()} provide the complete package for dedicated climbers.`
  : `${formattedValue} climbing requires specialized facilities, proper equipment, and expert setting. These ${gyms.length} gyms excel at providing world-class ${formattedValue.toLowerCase()} climbing experiences. From beginner-friendly instruction to challenging routes for advanced climbers, these facilities offer everything you need to master ${formattedValue.toLowerCase()} climbing technique and push your limits in a safe, supportive environment.`;

// Generate detailed content based on type
const aboutTitle = isAmenity
  ? `Why Choose Climbing Gyms with ${formattedValue}?`
  : `The ${formattedValue} Climbing Experience`;

const aboutContent = isAmenity
  ? `Modern climbing gyms recognize that the complete climbing experience extends beyond the walls. ${formattedValue} represent an essential amenity that separates good gyms from great ones. These facilities invest in comprehensive amenities because they understand climbers need more than just routes - they need a supportive environment that makes training convenient and enjoyable.

When evaluating climbing gyms, ${formattedValue.toLowerCase()} availability can significantly impact your satisfaction and training consistency. Gyms that prioritize these amenities typically show attention to detail across all aspects of their operation. The ${gyms.length} facilities in this category average ${avgRating} stars in ratings, demonstrating that quality amenities correlate with overall gym excellence.

The presence of ${formattedValue.toLowerCase()} also indicates a gym's commitment to creating a complete climbing community hub. These aren't just places to train - they're destinations where climbers can spend extended sessions, socialize with fellow enthusiasts, and fully immerse themselves in climbing culture. Whether you're training for outdoor projects or simply enjoy indoor climbing, having access to ${formattedValue.toLowerCase()} enhances every visit.

Location, climbing variety, and route quality remain crucial factors, but ${formattedValue.toLowerCase()} can be the deciding factor between similar gyms. Our directory highlights facilities that understand this balance, offering both exceptional climbing and the amenities that make regular training sustainable. Browse gyms by city and region to find the perfect facility combining world-class climbing with ${formattedValue.toLowerCase()} near you.`
  : `${formattedValue} climbing demands specific wall configurations, safety systems, and route setting expertise. The ${gyms.length} gyms in this category specialize in creating optimal ${formattedValue.toLowerCase()} climbing environments. Whether you're developing technique, building endurance, or preparing for outdoor climbs, these facilities provide dedicated spaces for ${formattedValue.toLowerCase()} climbing progression.

What separates exceptional ${formattedValue.toLowerCase()} climbing facilities from average ones? Professional route setting that challenges climbers at every level, regular route rotation keeping problems fresh and engaging, and comprehensive safety systems maintained by trained staff. The gyms featured here average ${avgRating} stars in ratings because they excel in these critical areas while fostering welcoming communities around ${formattedValue.toLowerCase()} climbing.

Many climbers seeking ${formattedValue.toLowerCase()} climbing opportunities wonder about equipment requirements and learning curves. Most facilities offering ${formattedValue.toLowerCase()} climbing provide rental gear and introductory classes making this discipline accessible to newcomers. ${gyms.filter(g => g.beginner_friendly).length} of these ${gyms.length} gyms are marked as beginner-friendly, offering instruction programs that safely introduce ${formattedValue.toLowerCase()} climbing fundamentals.

Beyond physical infrastructure, the best ${formattedValue.toLowerCase()} climbing gyms cultivate communities of passionate climbers who share knowledge, encouragement, and enthusiasm. These social environments accelerate learning and make consistent training more enjoyable. Browse our complete directory to find ${formattedValue.toLowerCase()} climbing facilities in your area, compare amenities and pricing, and discover the gym that matches your goals and skill level.`;

---

<BaseLayout
  title={seoData.title}
  description={seoData.description}
  canonical={seoData.canonical}
  keywords={seoData.keywords.split(', ')}
  schema={combinedSchema}
  breadcrumbs={breadcrumbs}
>
  <!-- Breadcrumb Navigation -->
  <nav class="text-sm mb-6" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2">
      {breadcrumbs.map((crumb, index) => (
        <li class="flex items-center gap-2">
          {index > 0 && <span class="text-gray-400">/</span>}
          {index === breadcrumbs.length - 1 ? (
            <span class="text-sage font-medium">{crumb.label}</span>
          ) : (
            <a href={crumb.url} class="text-granite hover:text-sage">
              {crumb.label}
            </a>
          )}
        </li>
      ))}
    </ol>
  </nav>

  <!-- Hero Section -->
  <header class="mb-12">
    <h1 class="text-4xl md:text-5xl font-bold text-granite mb-4">
      {pageTitle}
    </h1>
    <p class="text-xl text-gray-700 mb-6 leading-relaxed">
      {introText}
    </p>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-white p-6 rounded-lg shadow-md">
      <div>
        <p class="text-3xl font-bold text-sage">{gyms.length}</p>
        <p class="text-sm text-gray-600">Total Gyms</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-sage">{avgRating}★</p>
        <p class="text-sm text-gray-600">Average Rating</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-sage">${avgPrice}</p>
        <p class="text-sm text-gray-600">Avg Day Pass</p>
      </div>
      <div>
        <p class="text-3xl font-bold text-sage">
          ${priceRange.min}-${priceRange.max}
        </p>
        <p class="text-sm text-gray-600">Price Range</p>
      </div>
    </div>
  </header>

  <!-- Gym Grid -->
  <section class="mb-16">
    <h2 class="text-3xl font-bold text-granite mb-6">{pageTitle}</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {gyms.slice(0, 12).map(gym => (
        <GymCard gym={gym} showCity={true} />
      ))}
    </div>
  </section>

  <!-- About Section -->
  <section class="mb-16 bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold text-granite mb-6">{aboutTitle}</h2>

    <div class="prose prose-lg max-w-none">
      {aboutContent.split('\n\n').map(paragraph => (
        <p class="text-gray-700 mb-4 leading-relaxed">
          {paragraph}
        </p>
      ))}
    </div>
  </section>

  <!-- Comparison Table -->
  <section class="mb-16">
    <h2 class="text-3xl font-bold text-granite mb-6">Compare {isAmenity ? 'Gyms with' : ''} {formattedValue} {isAmenity ? '' : 'Climbing Gyms'}</h2>
    <div class="overflow-x-auto bg-white rounded-lg shadow-md">
      <table class="w-full text-left">
        <thead class="bg-sage text-white">
          <tr>
            <th class="px-6 py-3 font-semibold">Gym Name</th>
            <th class="px-6 py-3 font-semibold">Location</th>
            <th class="px-6 py-3 font-semibold">Rating</th>
            <th class="px-6 py-3 font-semibold">Day Pass</th>
            <th class="px-6 py-3 font-semibold">{isAmenity ? 'Other Amenities' : 'Climbing Types'}</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {gyms.map((gym, index) => (
            <tr class={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
              <td class="px-6 py-4">
                <a href={`/gyms/${gym.slug}`} class="text-sage hover:underline font-medium">
                  {gym.name}
                </a>
              </td>
              <td class="px-6 py-4 text-gray-700">
                {gym.city}, {gym.region}
              </td>
              <td class="px-6 py-4 font-medium">{gym.rating}★</td>
              <td class="px-6 py-4 text-gray-700">${gym.day_pass_price_local}</td>
              <td class="px-6 py-4 text-gray-700 text-sm">
                {isAmenity
                  ? gym.amenities?.split('|').filter(a => a !== value).slice(0, 3).map(a => formatText(a)).join(', ')
                  : gym.climbing_types?.split('|').map(ct => formatText(ct)).join(', ')
                }
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="mb-16 bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold text-granite mb-6">Frequently Asked Questions</h2>
    <div class="space-y-6">
      {faqs.map(faq => (
        <div>
          <h3 class="text-xl font-bold text-granite mb-2">{faq.question}</h3>
          <p class="text-gray-700 leading-relaxed">{faq.answer}</p>
        </div>
      ))}
    </div>
  </section>

  <!-- Related Categories -->
  <section class="mb-16">
    <h2 class="text-3xl font-bold text-granite mb-6">Explore More Categories</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <a
        href="/categories/best-bouldering-climbing-gyms"
        class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow"
      >
        <h3 class="text-lg font-bold text-sage mb-2">Best Bouldering Gyms</h3>
        <p class="text-sm text-gray-600">Top facilities for bouldering</p>
      </a>
      <a
        href="/categories/climbing-gyms-with-sauna"
        class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow"
      >
        <h3 class="text-lg font-bold text-sage mb-2">Gyms with Sauna</h3>
        <p class="text-sm text-gray-600">Recovery-focused facilities</p>
      </a>
      <a
        href="/categories/best-climbing-gyms-for-beginners"
        class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow"
      >
        <h3 class="text-lg font-bold text-sage mb-2">Beginner Friendly Gyms</h3>
        <p class="text-sm text-gray-600">Perfect for newcomers</p>
      </a>
      <a
        href="/categories/climbing-gyms-with-kids-zone"
        class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow"
      >
        <h3 class="text-lg font-bold text-sage mb-2">Gyms with Kids Zone</h3>
        <p class="text-sm text-gray-600">Family-friendly facilities</p>
      </a>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="bg-sage text-white p-8 rounded-lg shadow-md text-center">
    <h2 class="text-3xl font-bold mb-4">
      {isAmenity ? `Find Your Perfect Gym with ${formattedValue}` : `Start Your ${formattedValue} Climbing Journey`}
    </h2>
    <p class="text-lg mb-6">
      {isAmenity
        ? `Discover climbing gyms with ${formattedValue.toLowerCase()} amenities near you.`
        : `Find the best ${formattedValue.toLowerCase()} climbing facilities in your area.`
      }
    </p>
    <a
      href="/search"
      class="inline-block bg-white text-sage px-8 py-3 rounded-lg font-bold hover:bg-opacity-90 transition-colors"
    >
      Search All Gyms
    </a>
  </section>
</BaseLayout>
