---
/**
 * Training Load & Recovery Planner (Linkbait Tool MVP)
 * Client-side tool: session-RPE load, acute/chronic, ACR, charts, CSV export
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import AffiliateBlock from '../../components/AffiliateBlock.astro';
import { AFFILIATE_PRODUCTS } from '../../data/affiliateProducts';

export const prerender = true;

// SEO Metadata
const title = 'Climbing Training Load & Recovery Planner (Free) | ACR Calculator';
const description =
  'Free climbing training load planner: track minutes×RPE, see acute vs chronic load, and monitor acute:chronic ratio (ACR) to spot spikes. Private by default.';
const keywords = [
  'climbing training load',
  'climbing training load calculator',
  'acute chronic workload ratio',
  'acute:chronic ratio climbing',
  'ACR calculator',
  'session RPE climbing',
  'climbing deload planner',
  'climbing training tracker',
  'climbing injury prevention training load'
];

const canonical = 'https://www.indoorclimbinggym.com/tools/training-load-recovery-planner';

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', url: 'https://www.indoorclimbinggym.com/' },
  { label: 'Tools', url: 'https://www.indoorclimbinggym.com/tools' },
  { label: 'Training Load & Recovery Planner', url: canonical },
];

// Schema Markup
const toolSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebApplication',
  name: 'Training Load & Recovery Planner',
  description:
    'Track climbing training load using session RPE, compare acute vs chronic load, and monitor acute:chronic ratio (ACR).',
  url: canonical,
  applicationCategory: 'HealthApplication',
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD'
  },
  featureList: [
    'Session load (minutes × RPE)',
    'Acute load (7-day rolling sum)',
    'Chronic load (28-day rolling sum)',
    'Acute:Chronic Ratio (ACR) trend line',
    'CSV export'
  ],
  author: {
    '@type': 'Organization',
    name: 'IndoorClimbingGym.com'
  }
};

const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: [
    {
      '@type': 'Question',
      name: 'What is training load in climbing?',
      acceptedAnswer: {
        '@type': 'Answer',
        text:
          'Training load is a simple way to quantify how hard you trained. In this tool, load is estimated as minutes × RPE (rate of perceived exertion).'
      }
    },
    {
      '@type': 'Question',
      name: 'What is acute vs chronic workload?',
      acceptedAnswer: {
        '@type': 'Answer',
        text:
          'Acute workload is your recent load (here: last 7 days). Chronic workload is your longer-term baseline (here: last 28 days). Comparing them helps spot sudden spikes.'
      }
    },
    {
      '@type': 'Question',
      name: 'What is ACR (acute:chronic ratio)?',
      acceptedAnswer: {
        '@type': 'Answer',
        text:
          'ACR is acute load divided by chronic load. A higher ratio can indicate a sudden jump in training compared to your recent baseline. This tool is informational only, not medical advice.'
      }
    },
    {
      '@type': 'Question',
      name: 'Is this tool accurate for preventing injuries?',
      acceptedAnswer: {
        '@type': 'Answer',
        text:
          'It is a planning aid, not a diagnosis tool. It can help you notice spikes and patterns, but it cannot predict injuries. If you are injured or unsure, consult a qualified professional.'
      }
    },
    {
      '@type': 'Question',
      name: 'Where is my data stored?',
      acceptedAnswer: {
        '@type': 'Answer',
        text:
          'Your sessions are stored locally in your browser (localStorage). There is no account and no cloud sync in the MVP.'
      }
    }
  ]
};

const howToSchema = {
  '@context': 'https://schema.org',
  '@type': 'HowTo',
  name: 'How to track climbing training load',
  description: 'Use the planner to log sessions and monitor acute vs chronic load and ACR.',
  totalTime: 'PT1M',
  estimatedCost: {
    '@type': 'MonetaryAmount',
    currency: 'USD',
    value: '0'
  },
  step: [
    {
      '@type': 'HowToStep',
      position: 1,
      name: 'Log a session',
      text: 'Enter date, discipline, minutes, and RPE (1–10), then click Add.',
      url: canonical + '/#tool'
    },
    {
      '@type': 'HowToStep',
      position: 2,
      name: 'Review acute/chronic + ACR',
      text: 'Check your 7-day acute and 28-day chronic load, plus the ACR value and trend.',
      url: canonical + '/#tool'
    },
    {
      '@type': 'HowToStep',
      position: 3,
      name: 'Export if needed',
      text: 'Download CSV for coach review or your own spreadsheet tracking.',
      url: canonical + '/#tool'
    }
  ]
};

const schemas = [toolSchema, faqSchema, howToSchema];
---

<BaseLayout
  title={title}
  description={description}
  keywords={keywords}
  canonical={canonical}
  breadcrumbs={breadcrumbs}
  schema={schemas}
  ogType="website"
>
  <!-- Full-Width Hero Section (match other tools pages) -->
  <section class="w-screen relative left-1/2 right-1/2 -ml-[50vw] -mr-[50vw] -mt-8 bg-gradient-to-br from-sage/20 via-ivory to-sage/5 py-20 md:py-32 overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[radial-gradient(#98a48b_1px,transparent_1px)] [background-size:20px_20px]"></div>

    <div class="container mx-auto px-4 relative z-10 text-center">
      <div class="inline-block mb-6">
        <span class="inline-flex items-center px-4 py-2 bg-sage/10 text-sage font-bold rounded-full text-sm tracking-wide uppercase">
          Free Training Tool
        </span>
      </div>

      <h1 class="text-5xl md:text-6xl font-bold text-granite mb-6 leading-tight">
        Training Load & <span class="text-sage relative inline-block">
          Recovery Planner
          <svg class="absolute w-full h-3 -bottom-1 left-0 text-sage/30" viewBox="0 0 100 10" preserveAspectRatio="none">
            <path d="M0 5 Q 50 10 100 5" stroke="currentColor" stroke-width="8" fill="none" />
          </svg>
        </span>
      </h1>

      <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto leading-relaxed">
        Log sessions in seconds, see acute vs chronic load, and track your Acute:Chronic Ratio (ACR) to spot spikes.
        <span class="font-semibold">Private by default</span> — your data stays on your device.
      </p>

      <div class="grid grid-cols-3 gap-8 max-w-2xl mx-auto mt-10 opacity-80">
        <div class="text-center">
          <div class="text-2xl font-bold text-sage">100%</div>
          <div class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Free</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-sage">28 Days</div>
          <div class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Trend</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-sage">CSV</div>
          <div class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Export</div>
        </div>
      </div>

      <p class="text-sm text-gray-500 mt-6">
        Disclaimer: Informational only. Not medical advice.
      </p>
    </div>
  </section>

  <!-- Tool Card (Overlap Effect) -->
  <section id="tool" class="container mx-auto px-4 -mt-16 relative z-20 mb-16">
    <div class="bg-white rounded-3xl shadow-2xl border border-gray-100 p-6 md:p-10 max-w-6xl mx-auto">
      <div id="tlrp-app" class="min-h-[200px]">
        <p class="text-gray-600">Loading…</p>
      </div>
    </div>
  </section>

  <!-- SEO Content Sections -->
  <section class="container mx-auto px-4 max-w-6xl pb-20">
    <!-- Content cards (match other tools pages) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-8">
        <section class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
          <h2 class="text-3xl font-bold text-granite mb-4">Quick answer</h2>
          <p class="text-gray-700 leading-relaxed">
            Use this tool to estimate training load with <strong>minutes × RPE</strong>, then compare your
            <strong>acute load (7 days)</strong> against your <strong>chronic load (28 days)</strong>.
            The <strong>Acute:Chronic Ratio (ACR)</strong> trend is a simple way to notice when your training jumps faster
            than your recent baseline.
          </p>
          <p class="text-gray-700 leading-relaxed mt-4">
            This is not a medical model. It’s a planning dashboard: if you’re feeling beat up, you can quickly see whether
            your last week was a “normal week” for you—or a sudden spike.
          </p>
        </section>

        <section class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
          <h2 class="text-3xl font-bold text-granite mb-4">How it works (the simple math)</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-50 border border-gray-100 rounded-xl p-5">
              <h3 class="font-bold text-granite mb-2">Session load</h3>
              <p class="text-gray-700">Session load = <strong>minutes × RPE</strong> (RPE is 1–10).</p>
              <p class="text-sm text-gray-600 mt-2">Example: 60 minutes at RPE 7 → load 420.</p>
            </div>
            <div class="bg-gray-50 border border-gray-100 rounded-xl p-5">
              <h3 class="font-bold text-granite mb-2">Acute vs chronic</h3>
              <p class="text-gray-700">Acute = last 7 days. Chronic = last 28 days.</p>
              <p class="text-sm text-gray-600 mt-2">Think: “this week” vs “this month.”</p>
            </div>
            <div class="bg-gray-50 border border-gray-100 rounded-xl p-5">
              <h3 class="font-bold text-granite mb-2">ACR</h3>
              <p class="text-gray-700">ACR = acute ÷ chronic.</p>
              <p class="text-sm text-gray-600 mt-2">Higher = your week is bigger relative to your baseline.</p>
            </div>
            <div class="bg-gray-50 border border-gray-100 rounded-xl p-5">
              <h3 class="font-bold text-granite mb-2">Why it’s useful</h3>
              <p class="text-gray-700">Spikes often feel like “everything was fine… until it wasn’t.”</p>
              <p class="text-sm text-gray-600 mt-2">A consistent log turns that feeling into a pattern you can manage.</p>
            </div>
          </div>

          <div class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-lg">
            <p class="text-gray-800 font-semibold mb-2">How to interpret the labels</p>
            <ul class="text-gray-700 space-y-1">
              <li><strong>Stable</strong>: your week is in line with your recent baseline</li>
              <li><strong>Caution</strong> (ACR 1.3–1.5): you increased training—consider extra sleep/rest and watch skin/tendons</li>
              <li><strong>Spike</strong> (ACR &gt; 1.5): big jump—consider a lighter day or a deload block</li>
              <li><strong>Underload</strong> (ACR &lt; 0.8): training is low relative to baseline (can be fine for recovery weeks)</li>
            </ul>
            <p class="text-gray-700 mt-3">
              Remember: this is informational only. Bodies are weird. If something hurts, treat the symptom seriously.
            </p>
          </div>
        </section>

        <section class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
          <h2 class="text-3xl font-bold text-granite mb-4">RPE cheat sheet (climbing-friendly)</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-100 rounded-xl p-5">
              <div class="font-bold text-granite mb-1">RPE 3–4</div>
              <div class="text-gray-700">Easy technique / warmup, lots of margin.</div>
            </div>
            <div class="border border-gray-100 rounded-xl p-5">
              <div class="font-bold text-granite mb-1">RPE 5–6</div>
              <div class="text-gray-700">Moderate session, you could do more.</div>
            </div>
            <div class="border border-gray-100 rounded-xl p-5">
              <div class="font-bold text-granite mb-1">RPE 7–8</div>
              <div class="text-gray-700">Hard session, performance drops late.</div>
            </div>
            <div class="border border-gray-100 rounded-xl p-5">
              <div class="font-bold text-granite mb-1">RPE 9–10</div>
              <div class="text-gray-700">Max effort / limit, high fatigue cost.</div>
            </div>
          </div>
          <p class="text-gray-700 leading-relaxed mt-6">
            Tip: be consistent with your RPE scale. The absolute number matters less than using the same scale week-to-week.
          </p>
        </section>

        <section class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
          <h2 class="text-3xl font-bold text-granite mb-4">Best practices (so the tool actually helps)</h2>
          <div class="space-y-4 text-gray-700 leading-relaxed">
            <p>
              <strong>Log right after the session.</strong> Your memory of “how hard it was” changes fast.
              The best training logs are the ones you actually keep.
            </p>
            <p>
              <strong>Don’t chase numbers.</strong> ACR isn’t a score. It’s a trend indicator. Use it to notice patterns, not to justify smashing yourself.
            </p>
            <p>
              <strong>Use it to plan deloads.</strong> If you see multiple weeks trending up, plan an easier week before your body forces one.
              Most climbers progress faster when they schedule recovery instead of improvising it after a tweak.
            </p>
            <p>
              <strong>Keep it simple.</strong> Minutes + RPE captures a surprising amount. You can add details in the Notes field (e.g., “max hangs”, “board limit”, “comp-style volume”).
            </p>
          </div>
        </section>

        <section class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
          <h2 class="text-3xl font-bold text-granite mb-4">FAQ</h2>

          <div class="space-y-6">
            <div>
              <h3 class="text-xl font-bold text-granite mb-2">Is ACR a medical injury predictor?</h3>
              <p class="text-gray-700 leading-relaxed">
                No. Think of it as a planning signal. It can’t predict injuries, and it doesn’t replace common sense.
                If you’re injured or unsure, consult a qualified professional.
              </p>
            </div>
            <div>
              <h3 class="text-xl font-bold text-granite mb-2">Can I use this for bouldering and rope climbing?</h3>
              <p class="text-gray-700 leading-relaxed">
                Yes. Log any session with minutes and RPE. If you want clearer patterns, stay consistent with your discipline labels.
              </p>
            </div>
            <div>
              <h3 class="text-xl font-bold text-granite mb-2">Where is my data stored?</h3>
              <p class="text-gray-700 leading-relaxed">
                Locally in your browser (localStorage). No login and no cloud sync in the MVP.
              </p>
            </div>
            <div>
              <h3 class="text-xl font-bold text-granite mb-2">How do I share this with my coach?</h3>
              <p class="text-gray-700 leading-relaxed">
                Use the CSV export button to download your sessions and send it to them.
              </p>
            </div>
          </div>

          <div class="text-sm text-gray-500 mt-8">
            Word count note: this page intentionally includes deeper explanations so it can rank for training-load/ACR queries.
          </div>
        </section>

        <section class="bg-blue-50 border border-blue-200 rounded-2xl p-8">
          <h2 class="text-2xl font-bold text-granite mb-3">Related tools</h2>
          <ul class="space-y-2">
            <li><a class="text-blue-700 hover:underline" href="/tools/cost-per-climb-calculator/">Cost Per Climb Calculator</a></li>
            <li><a class="text-blue-700 hover:underline" href="/tools/bouldering-grade-conversion/">Bouldering Grade Converter</a></li>
            <li><a class="text-blue-700 hover:underline" href="/tools/sport-climbing-grade-conversion/">Sport Climbing Grade Converter</a></li>
          </ul>
        </section>
      </div>

      <aside class="lg:col-span-1 space-y-8">
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
          <h3 class="text-xl font-bold text-granite mb-3">Why this tool is link-worthy</h3>
          <p class="text-gray-700 leading-relaxed">
            Coaches, PTs, and gyms constantly need a simple way to talk about workload.
            Session-RPE is easy to understand, and this planner makes it visual.
          </p>
          <p class="text-gray-700 leading-relaxed mt-4">
            If you want to include it in a training plan doc, use the CSV export for quick sharing.
          </p>
        </div>

        <!-- Affiliate Products: training essentials -->
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
          <AffiliateBlock
            title="Training more? These make sessions smoother"
            subtitle="A basic hangboard/grip kit + finger tape can make structured training easier (and safer for your skin)."
            products={[
              AFFILIATE_PRODUCTS.find((p) => p.id === 'power-guidance-hangboard'),
              AFFILIATE_PRODUCTS.find((p) => p.id === 'fitbeast-grip-kit'),
              AFFILIATE_PRODUCTS.find((p) => p.id === 'friction-labs-tape'),
            ].filter(Boolean)}
            count={3}
          />
        </div>
      </aside>
    </div>
  </section>

  <!-- Client-side tool script (MVP) -->
  <script type="module">
    const STORAGE_KEY = 'icg.tlrp.sessions.v1';

    /** @typedef {{ id:string, date:string, discipline:string, minutes:number, rpe:number, notes:string }} Session */

    function uid() {
      return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`;
    }

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    function parseSessions() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed
          .map((s) => ({
            id: String(s.id || uid()),
            date: String(s.date || ''),
            discipline: String(s.discipline || 'boulder'),
            minutes: Number(s.minutes || 0),
            rpe: Number(s.rpe || 0),
            notes: String(s.notes || '')
          }))
          .filter((s) => /^\d{4}-\d{2}-\d{2}$/.test(s.date) && s.minutes > 0 && s.rpe >= 1 && s.rpe <= 10);
      } catch {
        return [];
      }
    }

    function saveSessions(sessions) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
    }

    function formatISODate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function sum(arr) {
      return arr.reduce((a, b) => a + b, 0);
    }

    function sessionLoad(s) {
      return (s.minutes || 0) * (s.rpe || 0);
    }

    function groupByDate(sessions) {
      const m = new Map();
      for (const s of sessions) {
        const load = sessionLoad(s);
        m.set(s.date, (m.get(s.date) || 0) + load);
      }
      return m;
    }

    function rollingSum(series, window) {
      const out = [];
      for (let i = 0; i < series.length; i++) {
        const start = Math.max(0, i - window + 1);
        out.push(sum(series.slice(start, i + 1)));
      }
      return out;
    }

    function render(appEl) {
      const sessions = parseSessions().sort((a, b) => a.date.localeCompare(b.date));

      const today = new Date();
      const end = formatISODate(today);
      const start = formatISODate(addDays(today, -27));
      const dayLoads = groupByDate(sessions);

      const labels = [];
      const loads = [];
      for (let i = 0; i < 28; i++) {
        const d = formatISODate(addDays(new Date(start), i));
        labels.push(d);
        loads.push(dayLoads.get(d) || 0);
      }

      const acute = rollingSum(loads, 7);
      const chronic = rollingSum(loads, 28);
      const eps = 1e-6;
      const acr = acute.map((a, i) => a / Math.max(chronic[i], eps));

      const latestIdx = labels.length - 1;
      const acuteNow = acute[latestIdx] || 0;
      const chronicNow = chronic[latestIdx] || 0;
      const acrNow = acr[latestIdx] || 0;

      let status = 'Stable';
      if (acrNow > 1.5) status = 'Spike';
      else if (acrNow >= 1.3) status = 'Caution';
      else if (acrNow < 0.8 && chronicNow > 0) status = 'Underload';

      const fmt = (n) => Math.round(n);
      const fmt2 = (n) => (Math.round(n * 100) / 100).toFixed(2);

      appEl.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-1">
            <div class="bg-sage/5 border border-sage/20 rounded-2xl p-5 mb-6">
              <div class="text-sm text-gray-600 mb-1">Today (last updated)</div>
              <div class="text-2xl font-bold text-granite mb-3">${status}</div>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div><div class="text-gray-500">Acute (7d)</div><div class="font-semibold">${fmt(acuteNow)}</div></div>
                <div><div class="text-gray-500">Chronic (28d)</div><div class="font-semibold">${fmt(chronicNow)}</div></div>
                <div><div class="text-gray-500">ACR</div><div class="font-semibold">${fmt2(acrNow)}</div></div>
                <div><div class="text-gray-500">Sessions</div><div class="font-semibold">${sessions.length}</div></div>
              </div>
              <div class="text-xs text-gray-500 mt-4">
                Non-medical guidance only.
              </div>
            </div>

            <form id="tlrp-form" class="border border-gray-100 rounded-2xl p-5">
              <div class="font-bold text-granite mb-4">Add session</div>
              <div class="grid grid-cols-2 gap-4">
                <label class="text-sm">
                  <span class="text-gray-600">Date</span>
                  <input name="date" type="date" value="${end}" class="mt-1 w-full border border-gray-200 rounded-xl px-3 py-2" />
                </label>
                <label class="text-sm">
                  <span class="text-gray-600">Discipline</span>
                  <select name="discipline" class="mt-1 w-full border border-gray-200 rounded-xl px-3 py-2">
                    <option value="boulder">Boulder</option>
                    <option value="rope">Rope</option>
                    <option value="board">Board</option>
                    <option value="conditioning">Conditioning</option>
                  </select>
                </label>
                <label class="text-sm">
                  <span class="text-gray-600">Minutes</span>
                  <input name="minutes" type="number" min="1" step="1" placeholder="60" class="mt-1 w-full border border-gray-200 rounded-xl px-3 py-2" />
                </label>
                <label class="text-sm">
                  <span class="text-gray-600">RPE (1–10)</span>
                  <input name="rpe" type="number" min="1" max="10" step="1" placeholder="7" class="mt-1 w-full border border-gray-200 rounded-xl px-3 py-2" />
                </label>
              </div>

              <label class="text-sm block mt-4">
                <span class="text-gray-600">Notes</span>
                <textarea name="notes" rows="2" placeholder="Optional" class="mt-1 w-full border border-gray-200 rounded-xl px-3 py-2"></textarea>
              </label>

              <div class="flex items-center gap-3 mt-5">
                <button type="submit" class="bg-sage text-white font-semibold px-4 py-2 rounded-xl hover:bg-sage/90">Add</button>
                <button type="button" id="tlrp-export" class="border border-gray-200 font-semibold px-4 py-2 rounded-xl hover:bg-gray-50">Export CSV</button>
              </div>

              <div class="text-xs text-gray-500 mt-3">
                RPE: 3–4 easy · 5–6 moderate · 7–8 hard · 9–10 max.
              </div>
            </form>
          </div>

          <div class="lg:col-span-2">
            <div class="border border-gray-100 rounded-2xl p-5">
              <div class="flex items-baseline justify-between mb-3">
                <div class="font-bold text-granite">Last 28 days</div>
                <div class="text-xs text-gray-500">Load = minutes × RPE</div>
              </div>
              <canvas id="tlrp-chart" height="240" class="w-full"></canvas>
              <div class="text-xs text-gray-500 mt-2">
                Bars: daily session load · Lines: acute (7d), chronic (28d), ACR
              </div>
            </div>

            <div class="border border-gray-100 rounded-2xl p-5 mt-6">
              <div class="font-bold text-granite mb-3">Recent sessions</div>
              <div class="overflow-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-left text-gray-500 border-b">
                      <th class="py-2 pr-2">Date</th>
                      <th class="py-2 pr-2">Discipline</th>
                      <th class="py-2 pr-2">Min</th>
                      <th class="py-2 pr-2">RPE</th>
                      <th class="py-2 pr-2">Load</th>
                      <th class="py-2 pr-2">Notes</th>
                      <th class="py-2"></th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sessions.slice(-12).reverse().map((s) => {
                      const load = sessionLoad(s);
                      const safeNotes = (s.notes || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                      return `
                        <tr class="border-b">
                          <td class="py-2 pr-2 whitespace-nowrap">${s.date}</td>
                          <td class="py-2 pr-2">${s.discipline}</td>
                          <td class="py-2 pr-2">${s.minutes}</td>
                          <td class="py-2 pr-2">${s.rpe}</td>
                          <td class="py-2 pr-2 font-semibold">${Math.round(load)}</td>
                          <td class="py-2 pr-2 max-w-[260px] truncate" title="${safeNotes}">${safeNotes}</td>
                          <td class="py-2 text-right">
                            <button data-del="${s.id}" class="text-red-600 hover:underline">Delete</button>
                          </td>
                        </tr>
                      `;
                    }).join('') || `
                      <tr><td class="py-3 text-gray-500" colspan="7">No sessions yet. Add one on the left.</td></tr>
                    `}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;

      const form = appEl.querySelector('#tlrp-form');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const date = String(fd.get('date') || '');
        const discipline = String(fd.get('discipline') || 'boulder');
        const minutes = Number(fd.get('minutes') || 0);
        const rpe = Number(fd.get('rpe') || 0);
        const notes = String(fd.get('notes') || '');

        if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert('Please pick a valid date.');
        if (!Number.isFinite(minutes) || minutes <= 0) return alert('Minutes must be > 0.');
        if (!Number.isFinite(rpe) || rpe < 1 || rpe > 10) return alert('RPE must be 1–10.');

        const next = parseSessions();
        next.push({ id: uid(), date, discipline, minutes: Math.round(minutes), rpe: clamp(Math.round(rpe), 1, 10), notes });
        saveSessions(next);
        render(appEl);
      });

      appEl.querySelector('#tlrp-export').addEventListener('click', () => {
        const all = parseSessions().sort((a,b)=>a.date.localeCompare(b.date));
        const rows = [
          ['date','discipline','minutes','rpe','session_load','notes'],
          ...all.map((s)=>[
            s.date,
            s.discipline,
            String(s.minutes),
            String(s.rpe),
            String(Math.round(sessionLoad(s))),
            (s.notes || '').replace(/\n/g,' ')
          ])
        ];
        const csv = rows.map(r => r.map(v => {
          const s = String(v ?? '');
          if (/[\",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
          return s;
        }).join(',')).join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'training-load-sessions.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      appEl.querySelectorAll('[data-del]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-del');
          const next = parseSessions().filter((s) => s.id !== id);
          saveSessions(next);
          render(appEl);
        });
      });

      const canvas = appEl.querySelector('#tlrp-chart');
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const w = canvas.clientWidth;
      const h = canvas.height;
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.scale(dpr, dpr);

      const maxLoad = Math.max(10, ...loads);
      const maxLine = Math.max(maxLoad, ...acute, ...chronic);
      const maxAcr = Math.max(1.8, ...acr);

      const padL = 36, padR = 10, padT = 10, padB = 28;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      function x(i) {
        return padL + (i / (labels.length - 1)) * plotW;
      }
      function yLoad(v) {
        return padT + (1 - v / maxLine) * plotH;
      }
      function yAcr(v) {
        return padT + (1 - v / maxAcr) * plotH;
      }

      ctx.clearRect(0, 0, w, h);
      ctx.strokeStyle = '#E5E7EB';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + plotH);
      ctx.lineTo(padL + plotW, padT + plotH);
      ctx.stroke();

      const barW = plotW / labels.length;
      ctx.fillStyle = 'rgba(152, 164, 139, 0.45)';
      for (let i = 0; i < loads.length; i++) {
        const bx = padL + i * barW;
        const bh = (loads[i] / maxLine) * plotH;
        ctx.fillRect(bx + 1, padT + plotH - bh, Math.max(1, barW - 2), bh);
      }

      function drawLine(series, yFn, color) {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < series.length; i++) {
          const px = x(i);
          const py = yFn(series[i]);
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
      }

      drawLine(acute, yLoad, '#5B7A5B');
      drawLine(chronic, yLoad, '#1F3D2B');
      drawLine(acr, yAcr, '#2563EB');

      ctx.fillStyle = '#6B7280';
      ctx.font = '10px system-ui, -apple-system, Segoe UI, Roboto';
      const labelEvery = 7;
      for (let i = 0; i < labels.length; i += labelEvery) {
        const text = labels[i].slice(5);
        ctx.fillText(text, x(i) - 12, padT + plotH + 16);
      }

      ctx.fillStyle = '#374151';
      ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillText('Acute', padL, 12);
      ctx.fillStyle = '#5B7A5B';
      ctx.fillRect(padL + 40, 5, 10, 3);
      ctx.fillStyle = '#374151';
      ctx.fillText('Chronic', padL + 60, 12);
      ctx.fillStyle = '#1F3D2B';
      ctx.fillRect(padL + 112, 5, 10, 3);
      ctx.fillStyle = '#374151';
      ctx.fillText('ACR', padL + 132, 12);
      ctx.fillStyle = '#2563EB';
      ctx.fillRect(padL + 158, 5, 10, 3);
    }

    const app = document.getElementById('tlrp-app');
    render(app);
  </script>
</BaseLayout>
