---
/**
 * Blog Index Page (/blog/ and /blog/[page])
 * Lists all blog posts with filtering and pagination
 */

export const prerender = true;

import { getCollection } from 'astro:content';
import type { Page } from 'astro';
import type { CollectionEntry } from 'astro:content';

import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import BlogCategories from '../../components/blog/BlogCategories.astro';
import { generateItemListSchema } from '../../utils/schema';

export async function getStaticPaths({ paginate }: { paginate: any }) {
  const allPosts = await getCollection('blog');
  const sortedPosts = allPosts.sort(
    (a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime()
  );

  return paginate(sortedPosts, { pageSize: 12 });
}

interface Props {
  page: Page<CollectionEntry<'blog'>>;
}

const { page } = Astro.props;

// Get post count from collection
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort(
  (a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime()
);
const postCount = sortedPosts.length;

// SEO metadata
const title = page.currentPage === 1
  ? 'Climbing Guides & Tips | Expert Advice for Climbers'
  : `Climbing Guides & Tips - Page ${page.currentPage}`;
const description = `${postCount} expert guides on indoor climbing. Techniques, gear reviews, gym costs & more. Written by climbers for beginners & pros.`;
const pageUrl = `https://www.indoorclimbinggym.com/blog${page.currentPage > 1 ? `/${page.currentPage}` : ''}`;

// Calculate pagination URLs for rel=prev/next
const prevUrl = page.currentPage > 1
  ? (page.currentPage === 2
      ? 'https://www.indoorclimbinggym.com/blog'
      : `https://www.indoorclimbinggym.com/blog/${page.currentPage - 1}`)
  : undefined;

const nextUrl = page.currentPage < page.lastPage
  ? `https://www.indoorclimbinggym.com/blog/${page.currentPage + 1}`
  : undefined;

// Generate ItemList schema for blog posts
const itemListSchema = generateItemListSchema(
  page.data.map((post, index) => ({
    id: index,
    name: post.data.title,
    slug: post.slug,
    full_address: '',
    city: '',
    region: '',
    postal_code: '',
    country: '',
    latitude: 0,
    longtitude: 0,
    phone: '',
    website: `https://www.indoorclimbinggym.com/blog/${post.slug}`,
    photo: post.data.heroImage,
    rating: 0,
    day_pass_price_local: 0,
    working_hour: '',
    amenities: '',
    climbing_types: '',
    description_short: post.data.description,
  })),
  'Indoor Climbing Guides and Articles',
  pageUrl
);

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', url: 'https://www.indoorclimbinggym.com' },
  { label: 'Guides', url: 'https://www.indoorclimbinggym.com/blog' },
];

if (page.currentPage > 1) {
    breadcrumbs.push({ label: `Page ${page.currentPage}`, url: pageUrl });
}

const keywords = [
  'climbing guides',
  'indoor climbing tips',
  'climbing gym advice',
  'bouldering tips',
  'rock climbing for beginners',
  'climbing gear reviews',
];
---

<BaseLayout
  title={title}
  description={description}
  canonical={pageUrl}
  keywords={keywords}
  schema={itemListSchema}
  breadcrumbs={breadcrumbs}
  prevUrl={prevUrl}
  nextUrl={nextUrl}
>
  <!-- Hero Section -->
  <section class="mb-12">
    <h1 class="text-4xl md:text-5xl font-bold text-granite mb-4">
      Indoor Climbing Guides & Resources
    </h1>
    <p class="text-xl text-gray-600 max-w-3xl">
      Expert advice, tips, and guides to help you climb better. From beginner tutorials to
      advanced techniques, gear reviews, and gym recommendations.
    </p>
  </section>

  <!-- Category Filter -->
  <BlogCategories currentCategory="all" />

  <!-- Blog Posts Grid -->
  {page.data.length > 0 ? (
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
      {page.data.map((post) => (
        <BlogCard
          slug={post.slug}
          title={post.data.title}
          description={post.data.description}
          publishedDate={post.data.publishedDate}
          author={post.data.author}
          category={post.data.category}
          heroImage={post.data.heroImage}
          heroImageAlt={post.data.heroImageAlt}
          readingTime={post.data.readingTime}
        />
      ))}
    </div>
  ) : (
    <div class="text-center py-16">
      <p class="text-xl text-gray-600">
        No articles yet. Check back soon for climbing guides and tips!
      </p>
    </div>
  )}

  <!-- Pagination -->
  {page.lastPage > 1 && (
    <nav class="flex justify-center items-center gap-2 mt-12" aria-label="Pagination">
      {page.url.prev && (
        <a
          href={page.url.prev}
          class="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50"
        >
          Previous
        </a>
      )}

      {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((pageNum) => (
        <a
          href={pageNum === 1 ? '/blog' : `/blog/${pageNum}`}
          class={`px-4 py-2 rounded ${
            pageNum === page.currentPage
              ? 'bg-sage text-white'
              : 'bg-white border border-gray-300 hover:bg-gray-50'
          }`}
        >
          {pageNum}
        </a>
      ))}

      {page.url.next && (
        <a
          href={page.url.next}
          class="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50"
        >
          Next
        </a>
      )}
    </nav>
  )}

  <!-- SEO-rich content section -->
  <section class="mt-16 prose max-w-none">
    <h2 class="text-2xl font-bold text-granite mb-4">Why Read Our Climbing Guides?</h2>
    <div class="grid md:grid-cols-2 gap-8 text-gray-600">
      <div>
        <h3 class="text-lg font-semibold text-granite mb-2">For Beginners</h3>
        <p>
          New to climbing? Our beginner guides cover everything from what to wear to your first
          gym, how much it costs, and basic techniques to get you started safely.
        </p>
      </div>
      <div>
        <h3 class="text-lg font-semibold text-granite mb-2">For Experienced Climbers</h3>
        <p>
          Looking to improve? Explore advanced techniques, training programs, gear reviews, and
          insights into the climbing gym industry.
        </p>
      </div>
    </div>
  </section>
</BaseLayout>
