---
/**
 * States Index Page (Power Page)
 * Directory of all states with climbing gyms
 * Shows states in grid format with gym counts
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import { generateSEO } from '../utils/seo';
import { generateItemListSchema } from '../utils/schema';
import { fetchGyms } from '../config/api';
import { getStateCode, getStateSlug, getStateName } from '../utils/states';
import AffiliateBlock from '../components/AffiliateBlock.astro';

export const prerender = true;

// Fetch all gyms
const gymsData = await fetchGyms();

// Count gyms by state (region field)
const stateCounts: Record<string, number> = {};
gymsData.forEach(gym => {
  const region = gym.region?.trim();
  if (region) {
    stateCounts[region] = (stateCounts[region] || 0) + 1;
  }
});

// Convert to array and sort by count DESC
const statesArray = Object.entries(stateCounts)
  .map(([stateName, count]) => {
    return {
      name: getStateName(stateName),      // "California", "Florida"
      code: getStateCode(stateName),      // "CA", "FL"
      slug: getStateSlug(stateName),      // "california", "florida"
      count
    };
  })
  .sort((a, b) => b.count - a.count);

// Calculate total stats
const totalGyms = gymsData.length;
const totalStates = statesArray.length;

// Generate SEO
const title = `Climbing Gyms by State | ${totalGyms} Gyms in ${totalStates} States`;
const description = `Browse ${totalGyms} climbing gyms across ${totalStates} US states. Filter by state to find gyms near you. Complete directory with ratings & prices.`;
const pageUrl = 'https://www.indoorclimbinggym.com/states';

const seo = generateSEO({
  title,
  description,
  canonical: pageUrl,
  keywords: [
    'climbing gyms by state',
    'indoor climbing directory',
    'bouldering gyms',
    'rock climbing gyms',
    'climbing facilities',
    'state climbing guide',
  ],
});

// Generate ItemList schema showing all states
const itemListSchema = generateItemListSchema(
  statesArray.map(state => ({
    id: state.slug,
    name: state.name,
    slug: state.slug,
    city: '',
    region: state.name,
    rating: 0,
  })) as any,
  'Climbing Gyms by State',
  pageUrl
);

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', url: '/' },
  { label: 'States', url: pageUrl },
];
---

<BaseLayout
  title={seo.title}
  description={seo.description}
  schema={itemListSchema}
  breadcrumbs={breadcrumbs}
>
  <!-- Breadcrumb -->
  <nav class="text-sm text-gray-600 mb-6" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2">
      <li><a href="/" class="hover:text-sage">Home</a></li>
      <li class="flex items-center gap-2">
        <span class="text-gray-400">/</span>
        <span class="text-granite font-medium">States</span>
      </li>
    </ol>
  </nav>

  <!-- Reverted Hero Section -->
  <header class="mb-12 text-center">
    <h1 class="text-4xl md:text-5xl font-bold text-granite mb-4">
      Climbing Gyms by State
    </h1>
    <p class="text-xl text-gray-700 leading-relaxed max-w-3xl mx-auto">
      Find indoor rock climbing and bouldering gyms across the United States.
      Browse {totalGyms} facilities in {totalStates} states to find your perfect climbing destination.
    </p>
  </header>

  <!-- Reverted Quick Stats -->
  <div class="grid grid-cols-2 md:grid-cols-3 gap-4 bg-sage/10 rounded-lg p-6 mb-12 max-w-4xl mx-auto">
    <div class="text-center">
      <div class="text-3xl font-bold text-sage">{totalStates}</div>
      <div class="text-sm text-gray-600">States</div>
    </div>
    <div class="text-center">
      <div class="text-3xl font-bold text-sage">{totalGyms}</div>
      <div class="text-sm text-gray-600">Total Gyms</div>
    </div>
    <div class="text-center col-span-2 md:col-span-1">
      <div class="text-3xl font-bold text-sage">{Math.round(totalGyms / totalStates)}</div>
      <div class="text-sm text-gray-600">Avg per State</div>
    </div>
  </div>

  <!-- States Grid Section (KEEPING IMPROVED CARDS) -->
  <section class="mb-12">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
      <div>
        <h2 class="text-3xl font-bold text-granite mb-2">
          Browse by State
        </h2>
        <p class="text-gray-700 max-w-2xl">
          Select a state below to explore all climbing gyms, compare prices and amenities,
          and find the perfect facility for your climbing needs.
        </p>
      </div>
      
      <!-- Sort Control -->
      <div class="w-full md:w-auto">
        <label for="sort-states" class="sr-only">Sort by</label>
        <div class="relative">
          <select 
            id="sort-states" 
            class="appearance-none bg-white border border-gray-300 text-granite py-2 pl-4 pr-10 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sage focus:border-transparent cursor-pointer w-full md:w-48"
          >
            <option value="count">Most Gyms</option>
            <option value="alpha">Alphabetical (A-Z)</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <div id="states-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {statesArray.map(state => (
        <a
          href={`/${state.slug}/`}
          class="group block p-6 bg-white rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-200 hover:border-sage/20 relative overflow-hidden"
          data-name={state.name}
          data-count={state.count}
        >
          <div class="absolute top-0 right-0 w-24 h-24 bg-sage/5 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
          
          <div class="flex items-center justify-between mb-4 relative z-10">
            <h3 class="text-xl font-bold text-granite group-hover:text-sage transition-colors">
              {state.name}
            </h3>
            <span class="px-3 py-1 text-xs font-bold bg-sage/10 text-sage rounded-full border border-sage/20 uppercase">
              {state.code}
            </span>
          </div>
          <div class="flex items-center gap-2 text-gray-500 relative z-10">
            <svg class="w-5 h-5 text-sage" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <span>{state.count} {state.count === 1 ? 'Gym' : 'Gyms'}</span>
          </div>
        </a>
      ))}
    </div>
  </section>

  <!-- Original Content Sections -->
  <section class="mb-12 bg-white rounded-lg shadow-md p-8">
    <h2 class="text-3xl font-bold text-granite mb-6">
      Why Choose Indoor Climbing?
    </h2>
    <div class="prose max-w-none text-gray-700 space-y-4">
      <p>
        Indoor climbing gyms offer a safe, controlled environment to learn and practice climbing skills
        year-round, regardless of weather conditions. Whether you're a complete beginner or an experienced
        climber training for outdoor objectives, indoor gyms provide the perfect setting to improve your
        technique, build strength, and connect with a supportive climbing community.
      </p>
      <p>
        Modern climbing facilities feature diverse terrain including bouldering walls, top rope routes,
        and lead climbing areas. Many gyms also offer training facilities with campus boards, systems walls,
        and fitness equipment to help you develop specific climbing skills. With professional route setters
        regularly updating problems and routes, you'll always find fresh challenges to keep you engaged
        and progressing.
      </p>
      <p>
        Beyond the climbing walls, most gyms foster welcoming communities where climbers of all levels
        can share beta, encourage each other, and build lasting friendships. Many facilities also offer
        classes, youth programs, and competitive opportunities, making climbing accessible and engaging
        for everyone from families to serious athletes.
      </p>
    </div>
  </section>

  <!-- Affiliate Block -->
  <div class="mb-16">
    <AffiliateBlock 
      title="Travel Gear for Climbers" 
      subtitle="Essential gear for your next climbing trip."
      category="gear"
      count={5}
    />
  </div>

  <!-- Original CTA Section -->
  <section class="text-center bg-gradient-to-r from-sage to-sage/80 rounded-lg p-12 text-white">
    <h2 class="text-3xl font-bold mb-4">
      Ready to Start Climbing?
    </h2>
    <p class="text-lg mb-8 text-white/90">
      Browse {totalGyms} climbing gyms across {totalStates} states to find your perfect match
    </p>
    <a
      href="#"
      onclick="window.scrollTo({top: 0, behavior: 'smooth'}); return false;"
      class="inline-block bg-white text-sage px-8 py-4 rounded-lg font-bold text-lg hover:bg-gray-100 transition-colors"
    >
      Browse States
    </a>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sortSelect = document.getElementById('sort-states');
      const grid = document.getElementById('states-grid');
      
      if (!sortSelect || !grid) return;

      const sortItems = (criteria) => {
        const items = Array.from(grid.children);
        
        const sorted = items.sort((a, b) => {
          if (criteria === 'count') {
            const countA = parseInt(a.getAttribute('data-count') || '0');
            const countB = parseInt(b.getAttribute('data-count') || '0');
            return countB - countA;
          } else {
            const nameA = a.getAttribute('data-name') || '';
            const nameB = b.getAttribute('data-name') || '';
            return nameA.localeCompare(nameB);
          }
        });
        
        grid.innerHTML = '';
        sorted.forEach(item => grid.appendChild(item));
      };

      sortSelect.addEventListener('change', (e) => {
        // @ts-ignore
        sortItems(e.target.value);
      });
    });
  </script>
</BaseLayout>
